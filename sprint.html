<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Ladder</title>
    <style>
        /* SAME CSS AS BEFORE + NEW STYLES */
        :root { --primary: #002366; --accent: #E30613; --bg: #f5f5f5; --card: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; max-width: 1100px; margin: 0 auto; padding: 20px; padding-bottom: 60px; }
        .nav-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .home-btn { text-decoration: none; background: #ddd; padding: 8px 15px; border-radius: 4px; font-weight: bold; color: #333; }
        
        /* ... (Paste the CSS from the previous Sprint App here) ... */
        /* I will include the critical CSS for the table/cards below */
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #eee; text-align: left; padding: 10px; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        .num-box { width: 60px; padding: 8px; text-align: center; font-weight: bold; }
        
        /* Copywrite Footer */
        .legal-footer { text-align: center; margin-top: 40px; color: #999; font-size: 0.8em; border-top: 1px solid #ccc; padding-top: 10px; }
        
        /* Hide elements */
        .hidden { display: none !important; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .btn { padding: 10px 20px; background: var(--primary); color: white; border: none; cursor: pointer; border-radius: 4px; }
        .btn-action { width: 100%; background: #28a745; margin-top: 10px; padding: 15px; font-size: 1.1em; }
        
        /* Heat Styles */
        .heat-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .heat-card { background: white; border: 1px solid #ccc; border-radius: 8px; }
        .heat-header { background: var(--primary); color: white; padding: 10px; font-weight: bold; }
        .rider-select { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .rider-select:hover { background: #f0f0f0; }
        
        /* Result Colors */
        .pos-1 { background: #d4edda; } 
        .pos-2 { background: #fff3cd; } 
        .pos-3 { background: #f8d7da; }
    </style>
</head>
<body>

<div class="nav-bar">
    <a href="index.html" class="home-btn">üè† Home</a>
    <h2 style="margin:0;">Sprint Ladder</h2>
</div>

<div id="phase-qualifying" class="card">
    <h3>Registration</h3>
    <p>Import format: <strong>Name, Number, Category</strong> (e.g., "John Smith, 101, A")</p>
    <textarea id="importArea" style="width:100%; height:80px;"></textarea>
    <button class="btn" onclick="importNames()">Import</button>
    
    <table style="margin-top:20px;">
        <thead><tr><th>#</th><th>Bib</th><th>Name</th><th>Cat</th><th>Time</th><th>X</th></tr></thead>
        <tbody id="riderTable"></tbody>
    </table>
    
    <div style="margin-top:15px; padding:10px; background:#e3f2fd;">
        <strong>Category:</strong> <select id="categoryFilter"><option value="ALL">All</option></select>
    </div>
    <button class="btn btn-action" onclick="generateHeats()">GENERATE HEATS</button>
</div>

<div id="phase-racing" class="card hidden">
    <h3>Race Card (<span id="roundBadge">Round 1</span>)</h3>
    <div id="heatsContainer" class="heat-container"></div>
    <button class="btn btn-action" onclick="finishRound()">CONFIRM & NEXT</button>
</div>

<div id="phase-standings" class="card hidden">
    <h3>Final Results</h3>
    <table id="resultsTable">
        <thead><tr><th>Rank</th><th>Bib</th><th>Name</th><th>Cat</th><th>Time</th></tr></thead>
        <tbody id="resultsBody"></tbody>
    </table>
    <button class="btn" onclick="hardReset()" style="margin-top:20px;">New Event</button>
</div>

<div class="legal-footer">
    &copy; 2024 Your Name. All Rights Reserved. Proprietary Software.
</div>

<script>
    // CORE LOGIC with RACE NUMBER Support
    let riders=[], activeRiders=[], heats=[], roundCounter=1, cats=new Set();
    const STORAGE_KEY='sprintData_Package';

    window.onload = () => {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        if(data.riders) { riders=data.riders; heats=data.heats; roundCounter=data.roundCounter; updateCats(); }
        if(heats && heats.length) { showPhase('phase-racing'); renderHeats(); } else { renderTable(); }
    };

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify({riders, heats, roundCounter})); }
    
    window.importNames = () => {
        const lines = document.getElementById('importArea').value.split('\n');
        lines.forEach(l => {
            if(!l.trim()) return;
            const parts = l.split(',').map(s => s.trim());
            // Logic: Detect if part 2 is a number (Bib) or text (Cat)
            let name = parts[0];
            let bib = '', cat = '';
            
            // Smart Parsing
            for(let i=1; i<parts.length; i++) {
                if(!isNaN(parts[i]) && parts[i].length < 5) bib = parts[i]; // It's a number
                else cat = parts[i]; // It's a category
            }
            
            riders.push({id:Date.now()+Math.random(), name, bib, cat, time:999});
        });
        document.getElementById('importArea').value=''; updateCats(); save(); renderTable();
    }

    function updateCats() {
        cats.clear(); riders.forEach(r=> { if(r.cat) cats.add(r.cat) });
        const sel = document.getElementById('categoryFilter');
        sel.innerHTML = '<option value="ALL">All</option>';
        Array.from(cats).sort().forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
    }

    window.updateRider = (id, field, val) => {
        const r = riders.find(x=>x.id==id);
        if(r) { r[field] = (field==='time') ? parseFloat(val)||999 : val; if(field==='cat') updateCats(); save(); }
    }

    function renderTable() {
        const tb = document.getElementById('riderTable'); tb.innerHTML='';
        riders.forEach((r,i) => {
            tb.innerHTML += `<tr>
                <td>${i+1}</td>
                <td><input class="num-box" value="${r.bib}" onchange="updateRider(${r.id},'bib',this.value)"></td>
                <td>${r.name}</td>
                <td><input style="width:50px" value="${r.cat}" onchange="updateRider(${r.id},'cat',this.value)"></td>
                <td><input style="width:70px" type="number" value="${r.time===999?'':r.time}" onchange="updateRider(${r.id},'time',this.value)"></td>
                <td><button onclick="delRider(${r.id})">x</button></td>
            </tr>`;
        });
    }
    
    window.delRider = (id) => { riders=riders.filter(r=>r.id!=id); save(); renderTable(); updateCats(); }

    window.generateHeats = () => {
        const cat = document.getElementById('categoryFilter').value;
        let pool = cat==='ALL' ? [...riders] : riders.filter(r=>r.cat===cat);
        if(pool.length<2) return alert("Need 2+ riders");
        pool.sort((a,b)=>a.time-b.time);
        
        heats=[]; 
        if(pool.length>=2) heats.push({name:"Heat A", riders:[pool.shift(), pool.shift()], res:[]});
        let c=66;
        while(pool.length) {
            let s=3; if(pool.length===4 || pool.length===2) s=2;
            if(pool.length===1) { heats[heats.length-1].riders.push(pool.shift()); continue; }
            let hr=[]; for(let i=0;i<s;i++) if(pool.length) hr.push(pool.shift());
            heats.push({name:"Heat "+String.fromCharCode(c++), riders:hr, res:[]});
        }
        roundCounter=1; save(); showPhase('phase-racing'); renderHeats();
    }

    function renderHeats() {
        const c = document.getElementById('heatsContainer'); c.innerHTML='';
        document.getElementById('roundBadge').innerText = "Round "+roundCounter;
        heats.forEach((h,i) => {
            let html = `<div class="heat-card"><div class="heat-header">${h.name}</div><div>`;
            h.riders.forEach(r => {
                let cls = h.res.indexOf(r.id)===0 ? 'pos-1' : (h.res.indexOf(r.id)===h.riders.length-1 && h.res.length>1 ? 'pos-3' : '');
                // DISPLAY BIB NUMBER HERE
                let bibDisplay = r.bib ? `<span style="background:#333; color:white; padding:2px 5px; border-radius:3px; font-size:0.8em; margin-right:5px;">#${r.bib}</span>` : '';
                
                html += `<div class="rider-select ${cls}" onclick="clickRider(${i},${r.id})">
                    ${bibDisplay} <strong>${r.name}</strong> <small>(${r.time}s)</small>
                </div>`;
            });
            c.innerHTML += html + '</div></div>';
        });
    }

    window.clickRider = (hi, rid) => {
        let h = heats[hi];
        h.res.includes(rid) ? h.res=h.res.filter(x=>x!=rid) : h.res.push(rid);
        save(); renderHeats();
    }

   window.finishRound = () => {
        // 1. Validation
        for(let h of heats) if(h.res.length!=h.riders.length) return alert("Finish all heats");
        
        // 2. Check if we are done (Sprint usually 3 rounds: Quarters, Semis, Finals)
        // If current round is the Total, then we are finished.
        if(roundCounter >= 3) { 
            roundCounter++; // Lock it
            save();
            showPhase('phase-standings'); 
            renderResults(); 
            return; 
        }
        
        // 3. Logic: Winner Up, Loser Down
        let next = heats.map(()=>[]);
        heats.forEach((h,i) => {
            let w=h.res[0];
            let l=h.res[h.res.length-1];
            
            // Winner moves to i-1 (Limit 0)
            i===0 ? next[0].push(riders.find(r=>r.id==w)) : next[i-1].push(riders.find(r=>r.id==w));
            
            // Loser moves to i+1 (Limit Length-1)
            i===heats.length-1 ? next[i].push(riders.find(r=>r.id==l)) : next[i+1].push(riders.find(r=>r.id==l));
            
            // Middle riders stay (if 3-up heat)
            for(let k=1; k<h.res.length-1; k++) next[i].push(riders.find(r=>r.id==h.res[k]));
        });
        
        // 4. Rebuild
        heats = next.map((rs,i) => ({
            name: heats[i].name, 
            riders: rs, 
            res:[]
        }));
        
        roundCounter++; 
        save(); 
        renderHeats();
    }
        
        // Rebuild objects
        heats = next.map((ids,i) => ({
            name: heats[i].name, 
            riders: ids.map(id => riders.find(r=>r.id==id)), 
            res:[]
        }));
        roundCounter++; save(); renderHeats();
    }

    function renderResults() {
        const tb = document.getElementById('resultsBody'); tb.innerHTML='';
        let rank=1;
        heats.forEach(h => h.res.forEach(rid => {
            let r = riders.find(x=>x.id==rid);
            tb.innerHTML += `<tr><td>${rank++}</td><td>${r.bib}</td><td>${r.name}</td><td>${r.cat}</td><td>${r.time}</td></tr>`;
        }));
    }

    function showPhase(id) {
        ['phase-qualifying','phase-racing','phase-standings'].forEach(p=>document.getElementById(p).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
    
    window.hardReset = () => { localStorage.removeItem(STORAGE_KEY); location.reload(); }
</script>
</body>
</html>
