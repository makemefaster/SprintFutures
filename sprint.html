<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Ladder</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #002366; --accent: #E30613; --bg: #f5f5f5; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; max-width: 1100px; margin: 0 auto; padding: 20px; padding-bottom:80px; }
        
        .nav-bar { display:flex; gap:10px; align-items:center; margin-bottom:20px; }
        .home-btn { background:#ddd; padding:8px 15px; border-radius:4px; text-decoration:none; color:#333; font-weight:bold; }
        
        .card { background:white; padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:20px; }
        .hidden { display:none !important; }
        .btn { padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:4px; cursor:pointer; }
        .btn-action { width:100%; background:#28a745; margin-top:10px; padding:15px; font-size:1.1em; }
        
        table { width:100%; border-collapse:collapse; margin-top:10px; }
        th { background:#eee; text-align:left; padding:10px; }
        td { padding:8px; border-bottom:1px solid #eee; }
        input { padding:5px; border:1px solid #ccc; border-radius:4px; }
        
        .heat-container { display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:15px; }
        .heat-card { background:white; border:1px solid #ccc; border-radius:8px; }
        .heat-header { background:var(--primary); color:white; padding:10px; font-weight:bold; }
        .rider-select { padding:10px; border-bottom:1px solid #eee; cursor:pointer; }
        
        /* Spectator Mode: Disable clicks */
        body.spectator .rider-select { pointer-events:none; }
        body.spectator .admin-only { display:none !important; }
        
        .pos-1 { background:#d4edda; } .pos-2 { background:#fff3cd; } .pos-3 { background:#f8d7da; }
        .rank-1 { background:#fff9c4; } 
    </style>
</head>
<body>

<div class="nav-bar">
    <a href="#" onclick="goHome()" class="home-btn">üè† Home</a>
    <h2 style="margin:0;">Sprint Ladder <span id="eventTag" style="font-size:0.6em; background:#E30613; color:white; padding:2px 6px; border-radius:4px;"></span></h2>
</div>

<div id="loginOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#002366; z-index:999; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white;">
    <h3>Event Access</h3>
    <input id="loginId" placeholder="Event ID" style="padding:10px; width:200px; margin-bottom:10px;">
    <input id="loginPin" type="password" placeholder="Admin PIN (Optional)" style="padding:10px; width:200px; margin-bottom:10px;">
    <button onclick="doLogin()" style="padding:10px 20px; font-weight:bold;">ENTER</button>
</div>

<div id="phase-qualifying" class="card hidden">
    <h3>1. Registration</h3>
    <div class="admin-only">
        <textarea id="importArea" style="width:100%; height:80px;" placeholder="Name, Bib, Cat"></textarea>
        <button class="btn" onclick="importNames()">Import</button>
        <button class="btn" style="background:#E30613; margin-left:10px;" onclick="wipeEvent()">‚ö† Reset</button>
    </div>
    <table><thead><tr><th>#</th><th>Bib</th><th>Name</th><th>Cat</th><th>Time</th><th></th></tr></thead><tbody id="riderTable"></tbody></table>
    <div class="admin-only" style="margin-top:15px; background:#e3f2fd; padding:10px;">
        Category: <select id="categoryFilter"><option value="ALL">All</option></select>
        <button class="btn btn-action" onclick="generateHeats()">GENERATE HEATS</button>
    </div>
</div>

<div id="phase-racing" class="card hidden">
    <h3>Race Card (<span id="roundBadge"></span>)</h3>
    <div id="heatsContainer" class="heat-container"></div>
    <div class="admin-only">
        <button class="btn btn-action" onclick="finishRound()">CONFIRM RESULT</button>
        <button class="btn" onclick="endEarly()" style="background:#E30613; margin-top:10px; font-size:0.8em;">End Event Early</button>
    </div>
</div>

<div id="phase-standings" class="card hidden">
    <h3>üèÅ Final Results</h3>
    <table><thead><tr><th>Rank</th><th>Bib</th><th>Name</th><th>Cat</th><th>Time</th><th>Heat</th></tr></thead><tbody id="resultsBody"></tbody></table>
    <button class="btn admin-only" onclick="wipeEvent()" style="margin-top:20px;">Start New Event</button>
</div>

<div style="text-align:center; margin-top:40px; border-top:1px solid #ccc; padding-top:20px;">
    <a href="https://www.buymeacoffee.com/YOUR_LINK" target="_blank" style="background:#FFDD00; color:black; padding:10px 20px; border-radius:20px; text-decoration:none; border:2px solid black; font-weight:bold;">‚òï Buy me a Beer</a>
</div>

<script>
    // --- FIREBASE CONFIG ---

const firebaseConfig = {

  apiKey: "AIzaSyAkTwI7TbJwXPbVQ2OrKjAAIaWLvyfuudc",

  authDomain: "sprintfutures.firebaseapp.com",

  projectId: "sprintfutures",

  storageBucket: "sprintfutures.firebasestorage.app",

  messagingSenderId: "535060943616",

  appId: "1:535060943616:web:d15fc5225538eaeb3459e5",

  measurementId: "G-9XFQV3PLEV
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- STATE ---
    let riders=[], heats=[], roundCounter=1, cats=new Set(), eventID='', isAdmin=false;
    const PIN = "1234";

    // --- INIT ---
    window.onload = () => {
        const p = new URLSearchParams(window.location.search);
        if(p.get('event')) {
            eventID = p.get('event');
            document.getElementById('eventTag').innerText = eventID;
            document.getElementById('loginOverlay').classList.add('hidden');
            if(p.get('auth')==='admin') { isAdmin=true; } 
            else { document.body.classList.add('spectator'); }
            startSync();
        }
    };

    function doLogin() {
        const id = document.getElementById('loginId').value.trim();
        const pin = document.getElementById('loginPin').value.trim();
        if(!id) return alert("Enter Event ID");
        let url = `?event=${id}`;
        if(pin===PIN) url += `&auth=admin`;
        window.location.href = url;
    }

    function startSync() {
        db.ref(`events/${eventID}/sprint`).on('value', snap => {
            const data = snap.val();
            if(data) {
                riders=data.riders||[]; heats=data.heats||[]; roundCounter=data.roundCounter||1;
                updateCats();
                if(data.isFinished) { showPhase('phase-standings'); renderResults(); }
                else if(heats.length>0) { showPhase('phase-racing'); renderHeats(); }
                else { showPhase('phase-qualifying'); renderTable(); }
            } else { renderTable(); }
        });
    }

    function save(finished=false) {
        if(!isAdmin) return;
        db.ref(`events/${eventID}/sprint`).set({riders, heats, roundCounter, isFinished:finished});
    }

    // --- LOGIC ---
    function importNames() {
        const txt = document.getElementById('importArea').value;
        if(!txt.trim()) return;
        txt.split('\n').forEach(l => {
            if(!l.trim()) return;
            const p = l.split(',').map(s=>s.trim());
            let name=p[0], bib='', cat='';
            if(p[1]) (!isNaN(p[1]) && p[1].length<5) ? (bib=p[1], cat=p[2]||'') : (cat=p[1]);
            riders.push({id:Date.now()+Math.random(), name, bib, cat, time:999});
        });
        document.getElementById('importArea').value=''; save();
    }

    function updateCats() {
        cats.clear(); riders.forEach(r=>{if(r.cat)cats.add(r.cat)});
        const s = document.getElementById('categoryFilter');
        if(s.options.length-1 !== cats.size) {
            s.innerHTML='<option value="ALL">All</option>';
            Array.from(cats).sort().forEach(c=>s.innerHTML+=`<option value="${c}">${c}</option>`);
        }
    }

    window.updateRider = (id,f,v) => { if(!isAdmin)return; let r=riders.find(x=>x.id==id); if(r){ r[f]=(f=='time'?parseFloat(v)||999:v); save(); } }
    
    function renderTable() {
        const tb=document.getElementById('riderTable'); tb.innerHTML='';
        riders.forEach((r,i) => {
            let ctrl = isAdmin ? `<button onclick="riders=riders.filter(x=>x.id!=${r.id});save()">X</button>` : '';
            let inputs = isAdmin ? 
                `<td><input style="width:40px" value="${r.bib||''}" onchange="updateRider(${r.id},'bib',this.value)"></td>
                 <td>${r.name}</td>
                 <td><input style="width:40px" value="${r.cat||''}" onchange="updateRider(${r.id},'cat',this.value)"></td>
                 <td><input style="width:60px" type="number" value="${r.time===999?'':r.time}" onchange="updateRider(${r.id},'time',this.value)"></td>` :
                `<td>${r.bib||''}</td><td>${r.name}</td><td>${r.cat||''}</td><td>${r.time===999?'-':r.time}</td>`;
            tb.innerHTML+=`<tr><td>${i+1}</td>${inputs}<td>${ctrl}</td></tr>`;
        });
    }

    window.generateHeats = () => {
        const cat = document.getElementById('categoryFilter').value;
        let pool = (cat==='ALL') ? [...riders] : riders.filter(r=>r.cat===cat);
        if(pool.length<2) return alert("Need 2+ riders");
        pool.sort((a,b)=>a.time-b.time);
        
        heats=[];
        if(pool.length>=2) heats.push({name:"Heat A", riders:[pool.shift(), pool.shift()], res:[]});
        let c=66;
        while(pool.length) {
            let s=3; if(pool.length===4||pool.length===2) s=2;
            if(pool.length===1) { if(heats.length) heats[heats.length-1].riders.push(pool.shift()); continue; }
            let hr=[]; for(let i=0;i<s;i++) if(pool.length) hr.push(pool.shift());
            heats.push({name:"Heat "+String.fromCharCode(c++), riders:hr, res:[]});
        }
        roundCounter=1; save();
    }

    function renderHeats() {
        const c=document.getElementById('heatsContainer'); c.innerHTML='';
        document.getElementById('roundBadge').innerText = "Round "+roundCounter;
        heats.forEach((h,i) => {
            let html=`<div class="heat-card"><div class="heat-header">${h.name}</div><div>`;
            h.riders.forEach(r => {
                let cls='', idx=h.res.indexOf(r.id);
                if(idx!==-1) cls = (idx===0?'pos-1':(idx===h.riders.length-1&&idx>0?'pos-3':'pos-2'));
                html+=`<div class="rider-select ${cls}" onclick="res(${i},${r.id})">
                    <strong>#${r.bib||''} ${r.name}</strong> <small>(${r.time}s)</small>
                </div>`;
            });
            c.innerHTML+=html+'</div></div>';
        });
    }

    window.res = (hi,rid) => { if(!isAdmin)return; let h=heats[hi]; h.res.includes(rid)?h.res=h.res.filter(x=>x!=rid):h.res.push(rid); save(); }

    window.finishRound = () => {
        for(let h of heats) if(h.res.length!=h.riders.length) return alert("Finish heats");
        if(roundCounter>=3) { save(true); return; }
        
        let next=heats.map(()=>[]);
        heats.forEach((h,i)=>{
            let w=h.res[0], l=h.res[h.res.length-1];
            i===0 ? next[0].push(riders.find(x=>x.id==w)) : next[i-1].push(riders.find(x=>x.id==w));
            i===heats.length-1 ? next[i].push(riders.find(x=>x.id==l)) : next[i+1].push(riders.find(x=>x.id==l));
            for(let k=1; k<h.res.length-1; k++) next[i].push(riders.find(x=>x.id==h.res[k]));
        });
        heats=next.map((rs,i)=>({name:heats[i].name, riders:rs, res:[]}));
        roundCounter++; save();
    }

    window.endEarly = () => { if(confirm("End Event?")) save(true); }
    window.wipeEvent = () => { if(confirm("Reset?")) { riders=[]; heats=[]; roundCounter=1; save(false); }}
    window.goHome = () => { let u=`index.html?event=${eventID}`; if(isAdmin) u+='&auth=admin'; window.location.href=u; }

    function renderResults() {
        const tb=document.getElementById('resultsBody'); tb.innerHTML='';
        let rank=1;
        heats.forEach(h => {
            let raced = (h.res && h.res.length===h.riders.length);
            let sorted = raced ? h.res.map(id=>riders.find(x=>x.id==id)) : [...h.riders].sort((a,b)=>a.time-b.time);
            sorted.forEach((r,idx) => {
                let cls = rank===1?'rank-1':'';
                tb.innerHTML+=`<tr class="${cls}"><td>${rank++}</td><td>${r.bib||''}</td><td>${r.name}</td><td>${r.cat||''}</td><td>${r.time}</td><td>${h.name} (${raced?idx+1:'Seeded'})</td></tr>`;
            });
        });
    }

    function showPhase(id) {
        ['phase-qualifying','phase-racing','phase-standings'].forEach(p=>document.getElementById(p).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
