<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Ladder</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#002366">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #002366; --accent: #E30613; --bg: #f5f5f5; --card: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; max-width: 1100px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }
        
        .nav-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .nav-group { display: flex; align-items: center; gap: 10px; }
        .home-btn { text-decoration: none; background: #ddd; padding: 8px 15px; border-radius: 4px; font-weight: bold; color: #333; }
        .unlock-btn { background: none; border: 1px solid #999; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; color: #666; }
        
        .sponsor-mini { margin-bottom: 20px; padding: 10px; background: white; border-bottom: 4px solid #00d2ff; text-align: center; }
        .card { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .hidden { display: none !important; }
        
        .btn { padding: 10px 20px; background: var(--primary); color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-action { width: 100%; background: #28a745; margin-top: 10px; padding: 15px; font-size: 1.1em; }
        .btn-danger { background: var(--accent); font-size: 0.8em; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;}
        .btn-secondary { background: #6c757d; font-size: 0.9em; margin-bottom: 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #eee; text-align: left; padding: 10px; border-bottom: 2px solid #ccc; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        input.num-box { width: 50px; text-align: center; font-weight: bold; }
        textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; box-sizing: border-box; }

        .heat-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .heat-card { background: white; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; }
        .heat-header { background: var(--primary); color: white; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; }
        .rider-select { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        
        body.admin-mode .rider-select:hover { background: #f0f0f0; }
        body:not(.admin-mode) .rider-select { pointer-events: none; }
        body:not(.admin-mode) .admin-only { display: none !important; }
        body.admin-mode .spectator-only { display: none !important; }

        .pos-1 { background: #d4edda; border-left: 5px solid #28a745; } 
        .pos-2 { background: #fff3cd; border-left: 5px solid #ffc107; } 
        .pos-3 { background: #f8d7da; border-left: 5px solid #dc3545; }
        .rank-1 { background: #fff9c4; font-weight: bold; }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #002366; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
    </style>
</head>
<body>

    <a href="https://www.frequencycycleworks.com/" target="_blank" style="text-decoration:none; color:inherit;">
        <div class="sponsor-mini">
            <span style="font-size:0.7em; text-transform:uppercase; color:#888;">Partner</span><br>
            <strong>FREQUENCY CYCLEWORKS</strong>
        </div>
    </a>

    <div class="nav-bar">
        <div class="nav-group">
            <a href="index.html" class="home-btn">üè† Home</a>
            <h2 style="margin:0;">Sprint Ladder <span id="eventTag" style="font-size:0.6em; background:#E30613; color:white; padding:2px 6px; border-radius:4px;">...</span></h2>
        </div>
        <button class="unlock-btn spectator-only" onclick="requestAdmin()">üîì Admin Login</button>
    </div>

    <div id="loginOverlay">
        <h3>Event Access</h3>
        <input id="loginId" placeholder="Event ID" style="padding:10px; width:200px; margin-bottom:10px;">
        <input id="loginPin" type="password" placeholder="Admin PIN (Optional)" style="padding:10px; width:200px; margin-bottom:10px;">
        <button onclick="doLogin()" style="padding:10px 20px; font-weight:bold; cursor:pointer;">ENTER</button>
    </div>

    <div id="phase-qualifying" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>1. Registration</h3>
            <div class="admin-only">
                <button class="btn btn-danger" onclick="wipeEvent()">üóë Reset Event</button>
            </div>
        </div>
        
        <div class="admin-only">
            <p style="color:#666; font-size:0.9em;">Format: <strong>Name, Bib, Cat</strong></p>
            <textarea id="importArea" placeholder="John Smith, 101, A&#10;Jane Doe, 102, B"></textarea>
            <button class="btn" onclick="importNames()">Import Riders</button>
        </div>
        
        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>#</th><th>Bib</th><th>Name</th><th>Cat</th><th>Time</th><th class="admin-only"></th></tr></thead>
                <tbody id="riderTable"></tbody>
            </table>
        </div>
        
        <div class="admin-only" style="margin-top:15px; padding:10px; background:#e3f2fd; border-radius:4px;">
            <strong>Category:</strong> <select id="categoryFilter" style="padding:5px;"><option value="ALL">All Categories</option></select>
        </div>
        <button class="btn btn-action admin-only" onclick="generateHeats()">GENERATE HEATS &rarr;</button>
    </div>

    <div id="phase-racing" class="card hidden">
        <div style="display:flex; justify-content:space-between;">
            <h3>Race Card</h3>
            <span style="background:#eee; padding:5px 10px; border-radius:10px; font-weight:bold;" id="roundBadge">Round 1</span>
        </div>
        
        <div class="admin-only" style="margin-bottom:15px;">
            <button class="btn btn-secondary" onclick="forcePhase('phase-qualifying')">‚úèÔ∏è Modify Entry / Add Riders</button>
        </div>

        <div id="heatsContainer" class="heat-container"></div>
        
        <div class="admin-only">
            <button class="btn btn-action" onclick="finishRound()">CONFIRM RESULT & NEXT ROUND &rarr;</button>
            <div style="text-align:right; margin-top:10px;">
                <button class="btn btn-danger" style="font-size:0.8em;" onclick="endEventEarly()">‚ö† End Event Early</button>
            </div>
        </div>
    </div>

    <div id="phase-standings" class="card hidden">
        <h3>üèÅ Final Results</h3>
        <table id="resultsTable">
            <thead><tr><th>Rank</th><th>Bib</th><th>Name</th><th>Cat</th><th>Time</th><th>Heat</th></tr></thead>
            <tbody id="resultsBody"></tbody>
        </table>
        <button class="btn admin-only" onclick="wipeEvent()" style="margin-top:20px; background:#666; width:100%;">Start New Event</button>
    </div>

    <div style="text-align:center; margin-top:40px; border-top:1px solid #ccc; padding-top:20px;">
        <a href="https://www.buymeacoffee.com/YOUR_LINK" target="_blank" style="background:#FFDD00; color:black; padding:10px 20px; border-radius:20px; text-decoration:none; border:2px solid black; font-weight:bold;">‚òï Buy me a Beer</a>
    </div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAkTwI7TbJwXPbVQ2OrKjAAIaWLvyfuudc",
      authDomain: "sprintfutures.firebaseapp.com",
      projectId: "sprintfutures",
      storageBucket: "sprintfutures.firebasestorage.app",
      messagingSenderId: "535060943616",
      appId: "1:535060943616:web:d15fc5225538eaeb3459e5",
      measurementId: "G-9XFQV3PLEV"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- STATE ---
    let riders=[], heats=[], roundCounter=1, cats=new Set();
    let eventID = "";
    let isAdmin = false;
    const PIN = "1234"; 

    // --- INIT ---
    window.onload = () => {
        const p = new URLSearchParams(window.location.search);
        const urlEvent = p.get('event');
        const urlAuth = p.get('auth');

        if(urlEvent) {
            eventID = urlEvent;
            document.getElementById('eventTag').innerText = eventID;
            
            if(urlAuth === 'admin') {
                enableAdmin();
            } else {
                document.getElementById('loginOverlay').style.display = 'none';
                startSync();
            }
        }
    };

    function enableAdmin() {
        isAdmin = true;
        document.body.classList.add('admin-mode');
        document.getElementById('loginOverlay').style.display = 'none';
        startSync();
    }

    function doLogin() {
        const id = document.getElementById('loginId').value.trim().toLowerCase();
        const pin = document.getElementById('loginPin').value.trim();
        if(!id) return alert("Enter Event ID");
        
        let url = `?event=${id}`;
        if(pin === PIN) url += `&auth=admin`;
        window.location.href = url;
    }

    function requestAdmin() {
        const pin = prompt("Enter Admin PIN:");
        if(pin === PIN) window.location.href = window.location.href + "&auth=admin";
        else alert("Incorrect PIN");
    }

    // --- FIREBASE SYNC ---
    function startSync() {
        db.ref(`events/${eventID}/sprint`).on('value', snap => {
            const data = snap.val();
            if(data) {
