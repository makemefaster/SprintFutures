<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Ladder</title>
    <style>
        :root { --primary: #002366; --accent: #E30613; --bg: #f5f5f5; --card: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; max-width: 1100px; margin: 0 auto; padding: 20px; padding-bottom: 60px; }
        .nav-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .home-btn { text-decoration: none; background: #ddd; padding: 8px 15px; border-radius: 4px; font-weight: bold; color: #333; }
        
        /* Layout & Cards */
        .hidden { display: none !important; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* Buttons */
        .btn { padding: 10px 20px; background: var(--primary); color: white; border: none; cursor: pointer; border-radius: 4px; font-weight:bold;}
        .btn-action { width: 100%; background: #28a745; margin-top: 10px; padding: 15px; font-size: 1.1em; }
        .btn-clear { background: #E30613; font-size: 0.8em; margin-left: 10px;}
        
        /* Import Area */
        textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; box-sizing: border-box; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; background: white; margin-top:15px; }
        th { background: #eee; text-align: left; padding: 10px; border-bottom: 2px solid #ccc;}
        td { padding: 8px; border-bottom: 1px solid #eee; }
        .num-box { width: 50px; padding: 5px; text-align: center; font-weight: bold; }
        
        /* Heats */
        .heat-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .heat-card { background: white; border: 1px solid #ccc; border-radius: 8px; overflow:hidden;}
        .heat-header { background: var(--primary); color: white; padding: 10px; font-weight: bold; }
        
        .rider-select { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display:flex; justify-content:space-between; align-items:center; }
        .rider-select:hover { background: #f0f0f0; }
        
        /* Colors */
        .pos-1 { background: #d4edda; border-left: 5px solid #28a745; } 
        .pos-2 { background: #fff3cd; border-left: 5px solid #ffc107; } 
        .pos-3 { background: #f8d7da; border-left: 5px solid #dc3545; }
        
        .legal-footer { text-align: center; margin-top: 40px; color: #999; font-size: 0.8em; border-top: 1px solid #ccc; padding-top: 10px; }
    </style>
</head>
<body>

<div class="nav-bar">
    <a href="index.html" class="home-btn">üè† Home</a>
    <h2 style="margin:0;">Sprint Ladder</h2>
</div>

<div id="phase-qualifying" class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>1. Registration</h3>
        <button class="btn btn-clear" onclick="clearRiders()">üóë Clear List</button>
    </div>
    
    <p style="color:#666; font-size:0.9em;">Format: <strong>Name, Bib, Category</strong> (e.g. "John, 101, A")</p>
    <textarea id="importArea" placeholder="John Smith, 101, A&#10;Jane Doe, 102, B"></textarea>
    <button class="btn" onclick="importNames()">Import Riders</button>
    
    <div style="overflow-x:auto;">
        <table>
            <thead><tr><th>#</th><th>Bib</th><th>Name</th><th>Cat</th><th>Time</th><th>X</th></tr></thead>
            <tbody id="riderTable"></tbody>
        </table>
    </div>
    
    <div style="margin-top:15px; padding:10px; background:#e3f2fd; border-radius:4px;">
        <strong>Race Category:</strong> <select id="categoryFilter" style="padding:5px;"><option value="ALL">All Categories</option></select>
    </div>
    <button class="btn btn-action" onclick="generateHeats()">GENERATE HEATS &rarr;</button>
</div>

<div id="phase-racing" class="card hidden">
    <div style="display:flex; justify-content:space-between;">
        <h3>Race Card</h3>
        <span style="background:#eee; padding:5px 10px; border-radius:10px; font-weight:bold;" id="roundBadge">Round 1</span>
    </div>
    <p style="font-size:0.9em; color:#666;">Click Winner (Green) then Loser (Red).</p>
    <div id="heatsContainer" class="heat-container"></div>
    <div style="text-align:right; margin-bottom:10px;">
    <button class="btn btn-clear" style="font-size:0.8em;" onclick="endEventEarly()">‚ö† End Event Early</button>
</div>
    <button class="btn btn-action" onclick="finishRound()">CONFIRM RESULT & NEXT ROUND &rarr;</button>
</div>

<div id="phase-standings" class="card hidden">
    <h3>üèÅ Final Results</h3>
    <table>
        <thead><tr><th>Rank</th><th>Bib</th><th>Name</th><th>Cat</th><th>Time</th></tr></thead>
        <tbody id="resultsBody"></tbody>
    </table>
    <button class="btn" onclick="hardReset()" style="margin-top:20px; background:#666;">Start New Event</button>
</div>

<div class="legal-footer">
    &copy; 2024. All Rights Reserved. Proprietary Software.
</div>

<script>
    // --- STATE ---
    let riders=[], heats=[], roundCounter=1, cats=new Set();
    const STORAGE_KEY='sprintData_Package_v2';

    // --- INIT ---
    window.onload = () => {
        try {
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            if(data.riders) { 
                riders=data.riders; heats=data.heats; roundCounter=data.roundCounter; 
                updateCats();
            }
            // Router
            if(heats && heats.length) {
                if(roundCounter >= 4) { // Assume 3 rounds max for Sprint
                    showPhase('phase-standings'); renderResults();
                } else {
                    showPhase('phase-racing'); renderHeats();
                }
            } else { 
                renderTable(); 
            }
        } catch(e) {
            console.log("Data reset");
            localStorage.removeItem(STORAGE_KEY);
        }
    };

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify({riders, heats, roundCounter})); }
    
    // --- IMPORT LOGIC (FIXED) ---
    window.importNames = () => {
        const val = document.getElementById('importArea').value;
        if(!val.trim()) return alert("Please type or paste names first.");
        
        const lines = val.split(/\r?\n/);
        let count = 0;

        lines.forEach(l => {
            if(!l.trim()) return;
            const parts = l.split(',').map(s => s.trim());
            
            // Default Values
            let name = parts[0];
            let bib = '';
            let cat = '';

            // Smart Detect: Is part 2 a number (Bib) or text (Cat)?
            if(parts.length > 1) {
                // If 2nd part is short number, assume Bib
                if(parts[1].length < 5 && !isNaN(parts[1])) {
                    bib = parts[1];
                    if(parts[2]) cat = parts[2]; // Then 3rd is Cat
                } else {
                    cat = parts[1]; // Otherwise 2nd is Cat
                }
            }
            
            riders.push({id:Date.now()+Math.random(), name, bib, cat, time:999});
            count++;
        });

        document.getElementById('importArea').value=''; 
        updateCats(); 
        save(); 
        renderTable();
        alert(`Imported ${count} riders.`);
    }

    window.clearRiders = () => {
        if(confirm("Clear the rider list?")) {
            riders = [];
            heats = [];
            roundCounter = 1;
            cats.clear();
            save();
            renderTable();
            updateCats();
        }
    }

    function updateCats() {
        cats.clear(); riders.forEach(r=> { if(r.cat) cats.add(r.cat) });
        const sel = document.getElementById('categoryFilter');
        sel.innerHTML = '<option value="ALL">All Categories</option>';
        Array.from(cats).sort().forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
    }

    window.updateRider = (id, field, val) => {
        const r = riders.find(x=>x.id==id);
        if(r) { 
            r[field] = (field==='time') ? parseFloat(val)||999 : val; 
            if(field==='cat') updateCats(); 
            save(); 
        }
    }

    function renderTable() {
        const tb = document.getElementById('riderTable'); tb.innerHTML='';
        riders.forEach((r,i) => {
            tb.innerHTML += `<tr>
                <td>${i+1}</td>
                <td><input class="num-box" value="${r.bib}" onchange="updateRider(${r.id},'bib',this.value)"></td>
                <td><strong>${r.name}</strong></td>
                <td><input style="width:50px" value="${r.cat}" onchange="updateRider(${r.id},'cat',this.value)"></td>
                <td><input style="width:70px" type="number" value="${r.time===999?'':r.time}" onchange="updateRider(${r.id},'time',this.value)"></td>
                <td><button onclick="delRider(${r.id})" style="color:red; font-weight:bold;">X</button></td>
            </tr>`;
        });
    }
    
    window.delRider = (id) => { riders=riders.filter(r=>r.id!=id); save(); renderTable(); updateCats(); }

    window.generateHeats = () => {
        const cat = document.getElementById('categoryFilter').value;
        let pool = cat==='ALL' ? [...riders] : riders.filter(r=>r.cat===cat);
        
        if(pool.length<2) return alert("Need at least 2 riders.");
        pool.sort((a,b)=>a.time-b.time);
        
        heats=[]; 
        // Heat A always 2
        if(pool.length>=2) heats.push({name:"Heat A", riders:[pool.shift(), pool.shift()], res:[]});
        
        let c=66; // B
        while(pool.length) {
            let s=3; 
            if(pool.length===4 || pool.length===2) s=2;
            if(pool.length===1) { if(heats.length) heats[heats.length-1].riders.push(pool.shift()); continue; }
            let hr=[]; for(let i=0;i<s;i++) if(pool.length) hr.push(pool.shift());
            heats.push({name:"Heat "+String.fromCharCode(c++), riders:hr, res:[]});
        }
        roundCounter=1; save(); showPhase('phase-racing'); renderHeats();
    }

    function renderHeats() {
        const c = document.getElementById('heatsContainer'); c.innerHTML='';
        document.getElementById('roundBadge').innerText = "Round "+roundCounter;
        
        heats.forEach((h,i) => {
            let html = `<div class="heat-card"><div class="heat-header">${h.name}</div><div>`;
            h.riders.forEach(r => {
                let idx = h.res.indexOf(r.id);
                let cls = '';
                if(idx===0) cls='pos-1';
                else if(idx===h.riders.length-1 && idx>0) cls='pos-3';
                else if(idx>0) cls='pos-2';
                
                let bibBadge = r.bib ? `<span style="background:#333; color:white; padding:2px 6px; border-radius:4px; font-size:0.8em; margin-right:5px;">#${r.bib}</span>` : '';

                html += `<div class="rider-select ${cls}" onclick="clickRider(${i},${r.id})">
                    <div>${bibBadge} <strong>${r.name}</strong></div>
                    <div style="font-size:0.9em;">${r.time===999?'-':r.time}s</div>
                </div>`;
            });
            c.innerHTML += html + '</div></div>';
        });
    }

    window.clickRider = (hi, rid) => {
        let h = heats[hi];
        h.res.includes(rid) ? h.res=h.res.filter(x=>x!=rid) : h.res.push(rid);
        save(); renderHeats();
    }

    window.finishRound = () => {
        for(let h of heats) if(h.res.length!=h.riders.length) return alert("Finish all heats");
        
        if(roundCounter>=3) { 
            roundCounter++; save(); showPhase('phase-standings'); renderResults(); return; 
        }
        
        let next = heats.map(()=>[]);
        heats.forEach((h,i) => {
            let w=h.res[0], l=h.res[h.res.length-1];
            // Winner Up (Limit 0)
            i===0 ? next[0].push(riders.find(r=>r.id==w)) : next[i-1].push(riders.find(r=>r.id==w));
            // Loser Down (Limit End)
            i===heats.length-1 ? next[i].push(riders.find(r=>r.id==l)) : next[i+1].push(riders.find(r=>r.id==l));
            // Middle Stay
            for(let k=1; k<h.res.length-1; k++) next[i].push(riders.find(r=>r.id==h.res[k]));
        });
        
        heats = next.map((rs,i) => ({ name: heats[i].name, riders: rs, res:[] }));
        roundCounter++; save(); renderHeats();
    }

  // 1. New Function to force finish
    window.endEventEarly = () => {
        if(confirm("‚ö† STOP RACING?\n\nThis will cancel remaining heats and generate final results based on the current seeding.")) {
            save(true); // Save as finished
            showPhase('phase-standings');
            renderResults();
        }
    }

    // 2. Updated Results Logic (Handles un-raced heats)
    function renderResults() {
        const tb = document.getElementById('resultsBody'); 
        tb.innerHTML='';
        let absoluteRank = 1;

        heats.forEach(h => {
            // DECISION: Did they race?
            let raced = (h.res && h.res.length === h.riders.length);
            
            // If raced, use results. If not, use Seeding (Qualifying Time)
            let sortedRiders = [];
            if (raced) {
                sortedRiders = h.res.map(id => riders.find(r => r.id == id));
            } else {
                // Clone array and sort by time (Fastest = Higher Rank)
                sortedRiders = [...h.riders].sort((a,b) => a.time - b.time);
            }

            sortedRiders.forEach((r, idx) => {
                let rankClass = '';
                if(absoluteRank === 1) rankClass = 'rank-1'; // Gold color class
                
                let finishText = raced ? `${h.name} - ${idx+1}${ordinal(idx+1)}` : `${h.name} (Seeded)`;

                tb.innerHTML += `<tr class="${rankClass}">
                    <td>${absoluteRank++}</td>
                    <td>${r.bib || '-'}</td>
                    <td>${r.name}</td>
                    <td>${r.cat || '-'}</td>
                    <td>${r.time}s</td>
                    <td style="font-size:0.9em; color:${raced?'#333':'#E30613'}">${finishText}</td>
                </tr>`;
            });
        });
    }

    function showPhase(id) {
        ['phase-qualifying','phase-racing','phase-standings'].forEach(p=>document.getElementById(p).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
    
    window.hardReset = () => { localStorage.removeItem(STORAGE_KEY); location.reload(); }
</script>
</body>
</html>
