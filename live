<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Race Centre</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#002366">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #002366; --accent: #E30613; --bg: #f5f5f5; --card: #ffffff; }
        body { font-family: 'Segoe UI', Helvetica, Arial, sans-serif; background: var(--bg); color: #333; max-width: 800px; margin: 0 auto; padding: 0; padding-bottom: 60px; }
        
        /* SPONSOR */
        .sponsor-mini { padding: 10px; background: white; border-bottom: 4px solid #00d2ff; text-align: center; }

        /* HEADER */
        .live-header { background: var(--primary); color: white; padding: 20px; text-align: center; }
        .live-badge { background: red; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7em; font-weight: bold; vertical-align: middle; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        /* TABS */
        .tabs { display: flex; background: #001a4d; }
        .tab { flex: 1; padding: 15px; text-align: center; color: #aaa; cursor: pointer; border-bottom: 4px solid transparent; font-weight: bold; }
        .tab.active { color: white; border-bottom-color: var(--accent); background: rgba(255,255,255,0.05); }

        /* CONTENT */
        .container { padding: 15px; }
        .hidden { display: none; }
        .section-title { font-size: 0.9em; text-transform: uppercase; color: #666; margin: 20px 0 10px 0; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        
        /* CARDS */
        .match-card { background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; overflow: hidden; }
        .match-header { background: #eee; padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; font-size: 0.9em; }
        .match-row { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; justify-content: space-between; }
        .match-row:last-child { border-bottom: none; }
        
        /* TAGS */
        .bib { background: #333; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-right: 8px; font-weight: bold; }
        .result-tag { font-size: 0.8em; font-weight: bold; padding: 4px 8px; border-radius: 4px; }
        .tag-1 { background: #d4edda; color: #155724; }
        .tag-pend { color: #999; font-style: italic; }

        /* STANDINGS TABLE */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th { background: #eee; text-align: left; padding: 10px; font-size: 0.9em; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.95em; }
        .gold { border-left: 4px solid gold; background: #fffde7; }
        .silver { border-left: 4px solid silver; }
        .bronze { border-left: 4px solid #cd7f32; }
    </style>
</head>
<body>

    <a href="https://www.frequencycycleworks.com/" target="_blank" style="text-decoration:none; color:inherit;">
        <div class="sponsor-mini">
            <span style="font-size:0.7em; text-transform:uppercase; color:#888;">Live Results Partner</span><br>
            <strong>FREQUENCY CYCLEWORKS</strong>
        </div>
    </a>

    <div class="live-header">
        <h2 style="margin:0;">Race Centre <span class="live-badge">LIVE</span></h2>
        <div id="eventIdDisplay" style="font-size:0.8em; opacity:0.8; margin-top:5px;">Waiting for Event ID...</div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('sprint')">Sprint</div>
        <div class="tab" onclick="switchTab('keirin')">Keirin</div>
    </div>

    <div id="view-sprint" class="container">
        <div id="sprint-loading">Loading Sprint Data...</div>
        <div id="sprint-content" class="hidden">
            <div id="sprint-rank-section" class="hidden">
                <div class="section-title">Final Standings</div>
                <table id="sprint-rank-table"><thead><tr><th>#</th><th>Bib</th><th>Name</th><th>Time</th></tr></thead><tbody id="sprint-rank-body"></tbody></table>
            </div>
            <div class="section-title">Up Next (Draw)</div>
            <div id="sprint-next-list"></div>
            <div class="section-title">Completed Heats</div>
            <div id="sprint-done-list"></div>
        </div>
    </div>

    <div id="view-keirin" class="container hidden">
        <div id="keirin-loading">Loading Keirin Data...</div>
        <div id="keirin-content" class="hidden">
            <div id="keirin-rank-section" class="hidden">
                <div class="section-title">Final Standings</div>
                <table id="keirin-rank-table"><thead><tr><th>#</th><th>Bib</th><th>Name</th><th>Time</th></tr></thead><tbody id="keirin-rank-body"></tbody></table>
            </div>
            <div class="section-title">Up Next (Draw)</div>
            <div id="keirin-next-list"></div>
            <div class="section-title">Completed Heats</div>
            <div id="keirin-done-list"></div>
        </div>
    </div>

<script>
    // --- 1. FIREBASE CONFIG (YOUR KEYS) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAkTwI7TbJwXPbVQ2OrKjAAIaWLvyfuudc",
      authDomain: "sprintfutures.firebaseapp.com",
      projectId: "sprintfutures",
      storageBucket: "sprintfutures.firebasestorage.app",
      messagingSenderId: "535060943616",
      appId: "1:535060943616:web:d15fc5225538eaeb3459e5",
      measurementId: "G-9XFQV3PLEV"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. INIT ---
    const params = new URLSearchParams(window.location.search);
    const eventID = params.get('event');
    
    if(eventID) {
        document.getElementById('eventIdDisplay').innerText = "Event: " + eventID;
        // Listen to Sprint
        db.ref(`events/${eventID}/sprint`).on('value', snap => {
            document.getElementById('sprint-loading').classList.add('hidden');
            renderApp('sprint', snap.val());
        });
        // Listen to Keirin
        db.ref(`events/${eventID}/keirin`).on('value', snap => {
            document.getElementById('keirin-loading').classList.add('hidden');
            renderApp('keirin', snap.val());
        });
    } else {
        document.body.innerHTML = "<div style='text-align:center; padding:50px;'><h3>No Event Selected</h3><p>Scan a QR code or use the main menu.</p></div>";
    }

    // --- 3. RENDER LOGIC ---
    function renderApp(type, data) {
        const content = document.getElementById(`${type}-content`);
        content.classList.remove('hidden');
        if(!data || !data.heats) { content.innerHTML = "<p style='color:#999; text-align:center;'>No racing data available yet.</p>"; return; }

        const nextList = document.getElementById(`${type}-next-list`);
        const doneList = document.getElementById(`${type}-done-list`);
        const rankSec = document.getElementById(`${type}-rank-section`);
        
        nextList.innerHTML = '';
        doneList.innerHTML = '';

        // Show Final Standings if done
        if(data.isFinished) {
            rankSec.classList.remove('hidden');
            renderStandings(type, data);
        } else {
            rankSec.classList.add('hidden');
        }

        // Render Heats
        data.heats.forEach(h => {
            const isComplete = h.res && h.res.length > 0;
            let html = `<div class="match-card"><div class="match-header"><span>${h.name}</span><span>${isComplete?'Finished':'Upcoming'}</span></div>`;

            h.riders.forEach(r => {
                let status = '<span class="tag-pend">Pending</span>';
                let style = "";
                
                if(isComplete) {
                    const idx = h.res.indexOf(r.id);
                    if(idx===0) { status='<span class="result-tag tag-1">1st</span>'; style="background:#f9fff9;"; }
                    else { status=`<span class="result-tag">${idx+1}${ordinal(idx+1)}</span>`; }
                }

                html += `<div class="match-row" style="${style}">
                    <div><span class="bib">${r.bib||'-'}</span> <strong>${r.name}</strong> <small style="color:#888">${r.cat||''}</small></div>
                    <div>${status}</div>
                </div>`;
            });
            html += `</div>`;

            if(isComplete) doneList.innerHTML += html;
            else nextList.innerHTML += html;
        });
        
        if(nextList.innerHTML==='') nextList.innerHTML="<p style='color:#ccc; font-style:italic;'>None</p>";
        if(doneList.innerHTML==='') doneList.innerHTML="<p style='color:#ccc; font-style:italic;'>None</p>";
    }

    function renderStandings(type, data) {
        const tbody = document.getElementById(`${type}-rank-body`);
        tbody.innerHTML = '';
        let rank = 1;
        
        // Sort based on Heat hierarchy logic (Admin logic)
        // If data.heats exists, we iterate heats to get rank order
        if(data.heats) {
            data.heats.forEach(h => {
                let racers = h.res ? h.res.map(id=>data.riders.find(x=>x.id==id)) : [];
                // Fallback if ended early (sort by time)
                if(!h.res || h.res.length===0) racers = [...h.riders].sort((a,b)=>a.time-b.time);

                racers.forEach(r => {
                    let cls = rank===1?'gold':(rank===2?'silver':(rank===3?'bronze':''));
                    tbody.innerHTML += `<tr class="${cls}"><td>${rank++}</td><td>${r.bib||''}</td><td><strong>${r.name}</strong></td><td>${r.time||'-'}</td></tr>`;
                });
            });
        }
    }

    // --- UTILS ---
    window.switchTab = (tab) => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
        
        // Manual class toggle because 'event.target' might not work in all contexts
        const tabs = document.querySelectorAll('.tab');
        if(tab==='sprint') tabs[0].classList.add('active');
        if(tab==='keirin') tabs[1].classList.add('active');
        
        document.getElementById(`view-${tab}`).classList.remove('hidden');
    }

    function ordinal(n) { const s=["th","st","nd","rd"], v=n%100; return s[(v-20)%10]||s[v]||s[0]; }
</script>
</body>
</html>
