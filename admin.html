<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Dashboard | SprintFutures</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-slate-100 min-h-screen p-6">

    <div class="max-w-5xl mx-auto space-y-6">
        
        <!-- Header -->
        <div class="flex items-center justify-between bg-white p-4 rounded-xl shadow-sm border border-slate-200">
            <div class="flex items-center space-x-3">
                <a href="index.html" class="bg-slate-100 hover:bg-slate-200 p-2 rounded-lg text-slate-600">üè†</a>
                <div>
                    <h1 class="text-xl font-bold text-slate-800">Event Dashboard</h1>
                    <span id="eventTag" class="text-xs bg-blue-600 text-white px-2 py-0.5 rounded font-bold uppercase">LOADING...</span>
                </div>
            </div>
            <div class="flex space-x-2">
                <button id="liveBtn" onclick="openLive()" class="hidden bg-slate-800 text-white px-4 py-2 rounded font-bold text-sm hover:bg-slate-700">üì∫ Spectator View</button>
            </div>
        </div>

        <!-- TWO COLUMN LAYOUT -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- LEFT: RIDER MANAGEMENT (2/3 width) -->
            <div class="md:col-span-2 space-y-6">
                
                <!-- Import Box -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-slate-800 mb-2">1. Bulk Import Riders</h2>
                    <p class="text-xs text-slate-500 mb-2">Format: <strong>Name, Bib, Category, Time (Optional)</strong></p>
                    <textarea id="importArea" class="w-full p-3 border border-slate-300 rounded-lg text-sm font-mono h-24 mb-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Harrie Lavreysen, 101, Elite, 9.45&#10;Jason Kenny, 102, Elite, 9.62"></textarea>
                    <button onclick="importNames()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold text-sm hover:bg-blue-700 transition">Import Riders</button>
                </div>

                <!-- Rider Table -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                        <h2 class="font-bold text-slate-700">2. Qualifying Times</h2>
                        <button onclick="wipeRiders()" class="text-red-500 text-xs font-bold hover:text-red-700">üóë Clear All</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50">
                                <tr>
                                    <th class="px-4 py-3">#</th>
                                    <th class="px-4 py-3">Bib</th>
                                    <th class="px-4 py-3">Name</th>
                                    <th class="px-4 py-3">Cat</th>
                                    <th class="px-4 py-3">Qualifying Time</th>
                                    <th class="px-4 py-3"></th>
                                </tr>
                            </thead>
                            <tbody id="riderTable" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- RIGHT: TOURNAMENT CONTROLS (1/3 width) -->
            <div class="space-y-6">
                
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 sticky top-6">
                    <h2 class="font-bold text-slate-800 mb-4">3. Launch Tournaments</h2>
                    <p class="text-xs text-slate-500 mb-6">These buttons open the race management tools in a new tab. They will use the rider data you entered on the left.</p>

                    <div class="space-y-3">
                        <button onclick="launch('sprint')" class="w-full flex items-center justify-between p-4 bg-white border-l-4 border-red-600 shadow-sm rounded hover:bg-red-50 transition group">
                            <span class="font-bold text-slate-700">üö¥ Sprint Ladder</span>
                            <span class="text-slate-300 group-hover:text-red-600">‚ûî</span>
                        </button>

                        <button onclick="launch('keirin')" class="w-full flex items-center justify-between p-4 bg-white border-l-4 border-indigo-900 shadow-sm rounded hover:bg-slate-50 transition group">
                            <span class="font-bold text-slate-700">üèÅ Keirin Ladder</span>
                            <span class="text-slate-300 group-hover:text-indigo-900">‚ûî</span>
                        </button>
                    </div>

                    <div class="mt-8 p-4 bg-yellow-50 rounded border border-yellow-200">
                        <p class="text-xs text-yellow-800 font-bold mb-1">üí° Tip</p>
                        <p class="text-xs text-yellow-700">Updates to times on this page will auto-sync to the tournament pages if you refresh them.</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        // --- EXPOSE FUNCTIONS TO HTML ---
        window.importNames = importNames;
        window.updateRider = updateRider;
        window.wipeRiders = wipeRiders;
        window.launch = launch;
        window.openLive = openLive;

        const firebaseConfig = {
            apiKey: "AIzaSyAkTwI7TbJwXPbVQ2OrKjAAIaWLvyfuudc",
            authDomain: "sprintfutures.firebaseapp.com",
            databaseURL: "https://sprintfutures-default-rtdb.firebaseio.com",
            projectId: "sprintfutures",
            storageBucket: "sprintfutures.firebasestorage.app",
            messagingSenderId: "535060943616",
            appId: "1:535060943616:web:d15fc5225538eaeb3459e5",
            measurementId: "G-9XFQV3PLEV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Get Event ID
        const params = new URLSearchParams(window.location.search);
        let eventID = params.get('event');

        // Security check
        if (!eventID || params.get('auth') !== 'admin') {
            window.location.href = 'index.html'; 
        } else {
            document.getElementById('eventTag').innerText = eventID.toUpperCase();
            
            // SHOW LIVE BUTTON ONLY IF NOT DEMO
            if (!eventID.startsWith('demo')) {
                document.getElementById('liveBtn').classList.remove('hidden');
            }
            
            startSync();
        }

        let riders = [];

        function startSync() {
            onValue(ref(db, `events/${eventID}/riders`), (snap) => {
                riders = snap.val() || [];
                renderTable();
            });
        }

        function importNames() {
            const val = document.getElementById('importArea').value;
            if(!val.trim()) return alert("Paste names first.");
            
            const lines = val.split(/\r?\n/);
            lines.forEach(l => {
                if(!l.trim()) return;
                const p = l.split(',').map(s => s.trim());
                
                let name = p[0];
                let bib = '';
                let cat = '';
                let time = 999;

                // Smart Parse (Supports optional time at end)
                if(p.length >= 2) {
                    if(!isNaN(p[1]) && p[1].length < 5) {
                        // Format: Name, Bib, Cat?, Time?
                        bib = p[1];
                        if(p[2]) cat = p[2];
                        if(p[3]) time = parseFloat(p[3]) || 999;
                    } else {
                        // Format: Name, Cat, Time?
                        cat = p[1];
                        if(p[2]) time = parseFloat(p[2]) || 999;
                    }
                }
                
                riders.push({id:Date.now()+Math.random(), name, bib, cat, time});
            });
            document.getElementById('importArea').value=''; 
            save();
        }

        function updateRider(id, f, v) {
            let r = riders.find(x => x.id == id);
            if(r) {
                r[f] = (f === 'time' ? parseFloat(v) || 999 : v);
                save();
            }
        }

        function save() {
            set(ref(db, `events/${eventID}/riders`), riders);
        }

        function wipeRiders() {
            if(confirm("Delete all riders and times? This cannot be undone.")) {
                riders = [];
                save();
            }
        }

        function renderTable() {
            const tb = document.getElementById('riderTable');
            tb.innerHTML = '';
            
            // Sort by time (ascending)
            riders.sort((a,b) => a.time - b.time);

            riders.forEach((r, i) => {
                tb.innerHTML += `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="px-4 py-3 text-slate-400">${i+1}</td>
                        <td class="px-4 py-3"><input class="w-12 border rounded text-center p-1" value="${r.bib||''}" onchange="updateRider(${r.id},'bib',this.value)"></td>
                        <td class="px-4 py-3"><input class="w-full border-b border-transparent focus:border-blue-500 outline-none bg-transparent font-bold text-slate-700" value="${r.name}" onchange="updateRider(${r.id},'name',this.value)"></td>
                        <td class="px-4 py-3"><input class="w-20 border rounded text-center p-1 text-xs uppercase" value="${r.cat||''}" onchange="updateRider(${r.id},'cat',this.value)"></td>
                        <td class="px-4 py-3"><input class="w-24 border rounded text-center p-1 font-mono text-blue-600 font-bold" type="number" step="0.001" value="${r.time===999?'':r.time}" onchange="updateRider(${r.id},'time',this.value)"></td>
                        <td class="px-4 py-3"><button onclick="riders=riders.filter(x=>x.id!=${r.id});save()" class="text-red-400 hover:text-red-600 font-bold">√ó</button></td>
                    </tr>`;
            });
        }

        function launch(page) {
            const url = new URL(page + '.html', window.location.href);
            url.searchParams.set('event', eventID);
            url.searchParams.set('auth', 'admin');
            window.open(url.toString(), '_blank');
        }

        function openLive() {
            const url = new URL('live.html', window.location.href);
            url.searchParams.set('event', eventID);
            window.open(url.toString(), '_blank');
        }
    </script>
</body>
</html>
