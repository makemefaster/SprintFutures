<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keirin Ladder</title>
    <style>
        /* Shared Styles */
        :root { --primary: #002366; --accent: #E30613; --bg: #f5f5f5; --card: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; max-width: 1100px; margin: 0 auto; padding: 20px; padding-bottom: 60px; }
        .nav-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .home-btn { text-decoration: none; background: #ddd; padding: 8px 15px; border-radius: 4px; font-weight: bold; color: #333; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th { background: #002366; color: white; text-align: left; padding: 12px; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        .num-box { width: 50px; padding: 5px; text-align: center; font-weight: bold; border: 1px solid #ccc; border-radius: 4px;}
        
        /* Layout */
        .hidden { display: none !important; }
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .btn { padding: 12px 20px; background: var(--primary); color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 1rem; font-weight: bold; }
        .btn-action { width: 100%; background: #28a745; margin-top: 15px; padding: 15px; font-size: 1.1em; }
        
        /* Heats */
        .heat-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .heat-card { background: white; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; }
        .heat-header { background: var(--primary); color: white; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; }
        .heat-body { padding: 0; }
        
        .rider-select { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .rider-select:hover { background: #f9f9f9; }
        
        /* Result Colors */
        .pos-top { background: #d4edda; border-left: 5px solid #28a745; } /* Green */
        .pos-bot { background: #f8d7da; border-left: 5px solid #dc3545; } /* Red */
        .pos-mid { background: #fff3cd; border-left: 5px solid #ffc107; } /* Yellow */
        
        /* Final Rank Colors */
        .rank-1 { background: #fff9c4; font-weight: bold; } /* Gold */
        .rank-2 { background: #f5f5f5; } /* Silver */
        .rank-3 { background: #ffe0b2; } /* Bronze */

        .legal-footer { text-align: center; margin-top: 40px; color: #999; font-size: 0.8em; border-top: 1px solid #ccc; padding-top: 10px; }
    </style>
</head>
<body>

<div class="nav-bar">
    <a href="index.html" class="home-btn">üè† Home</a>
    <h2 style="margin:0;">Keirin Ladder</h2>
</div>

<div id="phase-qualifying" class="card">
    <h3>1. Registration & Qualifying</h3>
    <p>Paste format: <strong>Name, Number, Category</strong> (e.g., "Jason Kenny, 105, Elite")</p>
    <textarea id="importArea" style="width:100%; height:80px; padding:10px;"></textarea>
    <button class="btn" onclick="importNames()">Import</button>
    
    <div style="margin-top:20px; max-height: 400px; overflow-y: auto;">
        <table>
            <thead><tr><th>#</th><th>Bib</th><th>Name</th><th>Cat</th><th>Time</th><th>X</th></tr></thead>
            <tbody id="riderTable"></tbody>
        </table>
    </div>
    
    <div style="margin-top:15px; padding:15px; background:#e3f2fd; border-radius: 4px;">
        <strong>Race Category:</strong> <select id="categoryFilter" style="padding: 5px; font-size: 1rem;"><option value="ALL">Race Everyone (All Categories)</option></select>
    </div>
    <button class="btn btn-action" onclick="generateHeats()">GENERATE HEATS</button>
</div>

<div id="phase-racing" class="card hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3>Race Card</h3>
        <span style="background:#eee; padding:5px 10px; border-radius:12px; font-weight:bold;" id="roundBadge">Round 1</span>
    </div>
    <p style="color:#666; font-size:0.9em;">Click riders in finish order (1st to Last).</p>
    <div id="heatsContainer" class="heat-container"></div>
    <button class="btn btn-action" onclick="finishRound()">CONFIRM RESULT & NEXT ROUND</button>
</div>

<div id="phase-standings" class="card hidden">
    <h3>üèÜ Final Results</h3>
    <table id="resultsTable">
        <thead><tr><th>Rank</th><th>Bib</th><th>Name</th><th>Cat</th><th>Qual Time</th><th>Final Heat</th></tr></thead>
        <tbody id="resultsBody"></tbody>
    </table>
    <button class="btn" onclick="hardReset()" style="margin-top:20px; background: #666;">Start New Event</button>
</div>

<div class="legal-footer">
    &copy; 2024. All Rights Reserved. Proprietary Software.
</div>

<script>
    // --- KEIRIN LOGIC ENGINE ---
    let riders=[], heats=[], roundCounter=1, cats=new Set();
    const STORAGE_KEY='keirinData_Pkg';
    const TOTAL_ROUNDS = 2; // Standard Keirin: Heats -> Finals

    window.onload = () => {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        if(data.riders) { riders=data.riders; heats=data.heats; roundCounter=data.roundCounter; updateCats(); }
        if(heats && heats.length) { 
            // If rounds are done, show results, else show racing
            if(roundCounter > TOTAL_ROUNDS) { showPhase('phase-standings'); renderResults(); }
            else { showPhase('phase-racing'); renderHeats(); }
        } else { renderTable(); }
    };

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify({riders, heats, roundCounter})); }
    
    window.importNames = () => {
        const lines = document.getElementById('importArea').value.split('\n');
        lines.forEach(l => {
            if(!l.trim()) return;
            const parts = l.split(',').map(s => s.trim());
            let name = parts[0];
            let bib = '', cat = '';
            for(let i=1; i<parts.length; i++) {
                if(!isNaN(parts[i]) && parts[i].length < 5) bib = parts[i];
                else cat = parts[i];
            }
            riders.push({id:Date.now()+Math.random(), name, bib, cat, time:999});
        });
        document.getElementById('importArea').value=''; updateCats(); save(); renderTable();
    }

    function updateCats() {
        cats.clear(); riders.forEach(r=> { if(r.cat) cats.add(r.cat) });
        const sel = document.getElementById('categoryFilter');
        sel.innerHTML = '<option value="ALL">Race Everyone</option>';
        Array.from(cats).sort().forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
    }

    window.updateRider = (id, field, val) => {
        const r = riders.find(x=>x.id==id);
        if(r) { r[field] = (field==='time') ? parseFloat(val)||999 : val; if(field==='cat') updateCats(); save(); }
    }

    function renderTable() {
        const tb = document.getElementById('riderTable'); tb.innerHTML='';
        riders.forEach((r,i) => {
            tb.innerHTML += `<tr>
                <td>${i+1}</td>
                <td><input class="num-box" value="${r.bib}" onchange="updateRider(${r.id},'bib',this.value)"></td>
                <td>${r.name}</td>
                <td><input style="width:60px" value="${r.cat}" onchange="updateRider(${r.id},'cat',this.value)"></td>
                <td><input style="width:70px" type="number" value="${r.time===999?'':r.time}" onchange="updateRider(${r.id},'time',this.value)"></td>
                <td><button onclick="delRider(${r.id})" style="color:red; font-weight:bold;">X</button></td>
            </tr>`;
        });
    }
    
    window.delRider = (id) => { riders=riders.filter(r=>r.id!=id); save(); renderTable(); updateCats(); }

    window.generateHeats = () => {
        const cat = document.getElementById('categoryFilter').value;
        let pool = cat==='ALL' ? [...riders] : riders.filter(r=>r.cat===cat);
        
        if(pool.length<4) return alert("Need at least 4 riders for Keirin.");
        pool.sort((a,b)=>a.time-b.time);
        
        heats=[]; 
        let c=65; // 'A'
        while(pool.length) {
            let s=6; // Keirin is usually 6-up
            let hr=[]; for(let i=0;i<s;i++) if(pool.length) hr.push(pool.shift());
            heats.push({name:"Heat "+String.fromCharCode(c++), riders:hr, res:[]});
        }
        roundCounter=1; save(); showPhase('phase-racing'); renderHeats();
    }

    function renderHeats() {
        const c = document.getElementById('heatsContainer'); c.innerHTML='';
        document.getElementById('roundBadge').innerText = roundCounter===TOTAL_ROUNDS ? "FINAL ROUND" : "Round "+roundCounter;
        
        heats.forEach((h,i) => {
            let html = `<div class="heat-card"><div class="heat-header"><span>${h.name}</span> <small>${h.riders.length} Riders</small></div><div class="heat-body">`;
            h.riders.forEach(r => {
                let idx = h.res.indexOf(r.id);
                let cls = '';
                let status = '';
                
                if(idx !== -1) {
                    // Logic for Round 1
                    if(roundCounter < TOTAL_ROUNDS) {
                         if(idx <= 1) { cls='pos-top'; status='‚¨ÜÔ∏è Up'; }
                         else if(idx >= h.riders.length-2) { cls='pos-bot'; status='‚¨áÔ∏è Down'; }
                         else { cls='pos-mid'; status='‚ÜîÔ∏è Stay'; }
                    } else {
                        // Logic for Finals (Gold/Silver/Bronze)
                        if(idx===0) cls='pos-top'; 
                    }
                }
                
                let bibDisplay = r.bib ? `<span style="background:#333; color:white; padding:2px 6px; border-radius:4px; font-weight:bold; margin-right:8px;">${r.bib}</span>` : '';
                
                html += `<div class="rider-select ${cls}" onclick="clickRider(${i},${r.id})">
                    <div>${bibDisplay} <strong>${r.name}</strong></div>
                    <div style="font-size:0.9em;">${idx!==-1 ? (idx+1)+ordinal(idx+1) : ''} ${status}</div>
                </div>`;
            });
            c.innerHTML += html + '</div></div>';
        });
    }

    window.clickRider = (hi, rid) => {
        let h = heats[hi];
        h.res.includes(rid) ? h.res=h.res.filter(x=>x!=rid) : h.res.push(rid);
        save(); renderHeats();
    }

    window.finishRound = () => {
        for(let h of heats) if(h.res.length!=h.riders.length) return alert("Please finish all heats first.");
        
        // If we just finished the finals
        if(roundCounter >= TOTAL_ROUNDS) { 
            roundCounter++; // Increment to lock state
            save(); 
            showPhase('phase-standings'); 
            renderResults(); 
            return; 
        }
        
        // LOGIC: SWAP RIDERS (Top 2 Up, Bottom 2 Down)
        let next = heats.map(()=>[]);
        heats.forEach((h,i) => {
            h.res.forEach((rid, idx) => {
                let r = riders.find(x=>x.id==rid);
                let isTop = idx<=1;
                let isBot = idx>=h.riders.length-2;
                
                // If Top 2: Move to i-1 (unless already in Heat A [0])
                if(isTop) { i===0 ? next[0].push(r) : next[i-1].push(r); }
                // If Bottom 2: Move to i+1 (unless already in last heat)
                else if(isBot) { i===heats.length-1 ? next[i].push(r) : next[i+1].push(r); }
                // Else Stay
                else { next[i].push(r); }
            });
        });
        
        // Rebuild objects
        heats = next.map((rs,i) => ({ name: heats[i].name, riders: rs, res:[] }));
        roundCounter++; save(); renderHeats();
    }

    function renderResults() {
        const tb = document.getElementById('resultsBody'); tb.innerHTML='';
        let absoluteRank = 1;
        
        // Rankings are linear based on Heat A, then Heat B, etc.
        heats.forEach(h => {
            h.res.forEach((rid, idx) => {
                let r = riders.find(x=>x.id==rid);
                let rankClass = '';
                if(absoluteRank === 1) rankClass = 'rank-1';
                else if(absoluteRank === 2) rankClass = 'rank-2';
                else if(absoluteRank === 3) rankClass = 'rank-3';

                tb.innerHTML += `<tr class="${rankClass}">
                    <td>${absoluteRank++}</td>
                    <td><strong>${r.bib || '-'}</strong></td>
                    <td>${r.name}</td>
                    <td>${r.cat || '-'}</td>
                    <td>${r.time}s</td>
                    <td>${h.name} - ${idx+1}${ordinal(idx+1)}</td>
                </tr>`;
            });
        });
    }

    function ordinal(n) {
        const s = ["th", "st", "nd", "rd"];
        const v = n % 100;
        return s[(v - 20) % 10] || s[v] || s[0];
    }

    function showPhase(id) {
        ['phase-qualifying','phase-racing','phase-standings'].forEach(p=>document.getElementById(p).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
    
    window.hardReset = () => { 
        if(confirm("This will wipe all race data. Are you sure?")) {
            localStorage.removeItem(STORAGE_KEY); location.reload(); 
        }
    }
</script>
</body>
</html>
