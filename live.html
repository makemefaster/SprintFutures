<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Results | SprintFutures</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Marquee Ticker */
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; }
        .marquee-content { display: inline-block; animation: marquee 30s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        
        /* Neon Glow */
        .neon-text { text-shadow: 0 0 10px rgba(56, 189, 248, 0.5), 0 0 20px rgba(56, 189, 248, 0.3); }
        
        /* Gold Text */
        .gold-text { text-shadow: 0 0 10px rgba(234, 179, 8, 0.5), 0 0 20px rgba(234, 179, 8, 0.3); color: #facc15; }
        
        /* Orange Glow for Slipstreamers */
        .orange-glow { text-shadow: 0 0 10px rgba(249, 115, 22, 0.5), 0 0 20px rgba(249, 115, 22, 0.3); }

        /* Podium Effects */
        .podium-gold { background: linear-gradient(135deg, #846404 0%, #f6e27a 50%, #846404 100%); animation: shimmer 3s linear infinite; color: #422a02; border: 1px solid #ffd700; }
        .podium-silver { background: linear-gradient(135deg, #3d4349 0%, #aeb5bc 50%, #3d4349 100%); animation: shimmer 4s linear infinite; color: #1a202c; border: 1px solid #cbd5e0; }
        .podium-bronze { background: linear-gradient(135deg, #4b2c20 0%, #c48660 50%, #4b2c20 100%); animation: shimmer 5s linear infinite; color: #2d1a12; border: 1px solid #d69e2e; }
        @keyframes shimmer { 0% {background-position: 0% 50%} 100% {background-position: 100% 50%} }

        /* Custom Scrollbar Styling (Visible) */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <div class="bg-slate-900 border-b border-slate-700 p-4 shadow-xl z-20">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center space-x-4 w-full md:w-auto justify-between md:justify-start">
                <div class="flex items-center space-x-3">
                    <a href="index.html" class="bg-slate-800 hover:bg-slate-700 p-3 rounded-xl text-slate-300 transition border border-slate-600">
                        <span class="text-xl">üè†</span>
                    </a>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-black tracking-tight text-white italic uppercase leading-none">Live Feed</h1>
                        <div id="eventTag" class="text-[0.65rem] inline-block bg-green-500 text-black px-2 py-0.5 rounded font-bold uppercase tracking-wider mt-1 shadow-[0_0_10px_rgba(34,197,94,0.6)]">Connecting...</div>
                    </div>
                </div>
            </div>
            
            <!-- SPONSOR AREA (Dynamic) -->
            <div class="w-full md:w-auto" id="sponsorArea">
                <div class="bg-gradient-to-r from-slate-800 to-slate-900 border border-slate-600 rounded-xl p-4 flex flex-col items-center md:items-end shadow-2xl relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000 ease-in-out"></div>
                    <p id="sponsorLabel" class="text-[0.6rem] text-sky-400 uppercase tracking-[0.3em] font-bold mb-1">Official Event Partner</p>
                    <div id="sponsorTitle" class="font-black text-2xl md:text-4xl text-white tracking-tighter italic neon-text">
                        FREQUENCY <span class="text-sky-400">CYCLEWORKS</span>
                    </div>
                    <p id="sponsorSub" class="text-xs text-slate-400 font-mono tracking-wide mt-1">High Performance Track Components</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="flex-grow p-4 overflow-hidden relative">
        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
            
            <!-- SPRINT COLUMN -->
            <div class="bg-slate-800/50 rounded-2xl overflow-hidden border border-slate-700 flex flex-col shadow-lg backdrop-blur-sm">
                <div class="bg-gradient-to-r from-red-600 to-red-800 p-4 flex justify-between items-center shadow-md z-10">
                    <div class="flex items-center space-x-2">
                        <span class="text-2xl">üö¥</span>
                        <h2 class="font-black text-xl italic uppercase tracking-wide">Sprint Ladder</h2>
                    </div>
                    <span id="sprintRound" class="text-xs bg-black/40 px-3 py-1 rounded-full font-mono border border-white/10">Round -</span>
                </div>
                <!-- REMOVED scrollbar-hide to allow manual scrolling -->
                <div id="sprintContainer" class="p-4 space-y-4 overflow-y-auto flex-grow relative">
                    <div class="text-center text-slate-500 py-20 animate-pulse font-mono">Waiting for race data...</div>
                </div>
            </div>

            <!-- KEIRIN COLUMN -->
            <div class="bg-slate-800/50 rounded-2xl overflow-hidden border border-slate-700 flex flex-col shadow-lg backdrop-blur-sm">
                <div class="bg-gradient-to-r from-indigo-600 to-indigo-800 p-4 flex justify-between items-center shadow-md z-10">
                    <div class="flex items-center space-x-2">
                        <span class="text-2xl">üèÅ</span>
                        <h2 class="font-black text-xl italic uppercase tracking-wide">Keirin Ladder</h2>
                    </div>
                    <span id="keirinRound" class="text-xs bg-black/40 px-3 py-1 rounded-full font-mono border border-white/10">Round -</span>
                </div>
                <!-- REMOVED scrollbar-hide to allow manual scrolling -->
                <div id="keirinContainer" class="p-4 space-y-4 overflow-y-auto flex-grow relative">
                    <div class="text-center text-slate-500 py-20 animate-pulse font-mono">Waiting for race data...</div>
                </div>
            </div>

        </div>
    </div>

    <!-- FOOTER -->
    <div class="bg-black border-t-4 border-orange-600 relative z-30">
        <div class="absolute left-0 top-0 bottom-0 bg-orange-600 text-white font-black text-xs px-2 flex items-center z-10 shadow-lg uppercase tracking-widest writing-vertical-lr sm:writing-horizontal-tb">Sponsors</div>
        <div class="marquee-container py-3 bg-gradient-to-b from-slate-900 to-black">
            <div class="marquee-content flex items-center space-x-16 px-4">
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-yellow-500 mr-2 text-2xl">‚ö°</span> WATTSHOP</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-red-600 mr-2 text-2xl">‚óè</span> MAVIC</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-white mr-2 text-2xl">üö≤</span> DOLAN</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-blue-500 mr-2 text-2xl">‚ñ≤</span> SHIMANO</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-orange-500 mr-2 text-2xl">‚ñ†</span> LOOK CYCLE</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-green-500 mr-2 text-2xl">‚ùñ</span> VELODROME SHOP</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-purple-500 mr-2 text-2xl">‚òÖ</span> KASK</span>
                <!-- Duplicate for loop -->
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-yellow-500 mr-2 text-2xl">‚ö°</span> WATTSHOP</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-red-600 mr-2 text-2xl">‚óè</span> MAVIC</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-white mr-2 text-2xl">üö≤</span> DOLAN</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-blue-500 mr-2 text-2xl">‚ñ≤</span> SHIMANO</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-orange-500 mr-2 text-2xl">‚ñ†</span> LOOK CYCLE</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-green-500 mr-2 text-2xl">‚ùñ</span> VELODROME SHOP</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-purple-500 mr-2 text-2xl">‚òÖ</span> KASK</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        const params = new URLSearchParams(window.location.search);
        const eventID = params.get('event');

        // --- DYNAMIC BRANDING LOGIC ---
        function checkBranding(id) {
            if(!id) return;
            const cleanId = id.toLowerCase();
            
            // LOGIC FOR HSS EVENTS
            if(cleanId.includes('hss')) {
                const title = document.getElementById('sponsorTitle');
                const sub = document.getElementById('sponsorSub');
                const label = document.getElementById('sponsorLabel');
                
                label.innerText = "Event Supported By";
                label.className = "text-[0.6rem] text-orange-400 uppercase tracking-[0.3em] font-bold mb-1";
                
                // Slipstreamers Branding (Orange theme)
                title.innerHTML = `HILLINGDON <span class="text-orange-500">SLIPSTREAMERS</span>`;
                title.className = "font-black text-xl md:text-3xl text-white tracking-tighter italic orange-glow";
                
                sub.innerHTML = `<a href="https://www.slipstreamers.co.uk/" target="_blank" class="hover:text-orange-300 transition border-b border-transparent hover:border-orange-300">www.slipstreamers.co.uk</a>`;
                sub.className = "text-xs text-yellow-300 font-mono tracking-wide mt-1";
            }
        }

        // --- AUTO SCROLL LOGIC ---
        let lastUpdate = Date.now();
        let scrollInterval = null;
        let userInteracting = false;
        
        function resetScrollTimer() {
            lastUpdate = Date.now();
            stopScrolling();
        }

        // Listen for user interaction (Removed 'mousemove' to be less sensitive)
        ['touchstart', 'wheel', 'click'].forEach(evt => {
            document.addEventListener(evt, () => {
                userInteracting = true;
                stopScrolling();
                lastUpdate = Date.now(); // Reset idle timer
                
                // Debounce interaction flag
                clearTimeout(window.userScrollTimeout);
                window.userScrollTimeout = setTimeout(() => {
                    userInteracting = false;
                }, 10000); // Wait 10s after interaction before resuming
            });
        });
        
        setInterval(() => {
            if (!userInteracting && Date.now() - lastUpdate > 60000) { // 60 Seconds idle
                startScrolling();
            }
        }, 1000);

        function startScrolling() {
            if (scrollInterval) return; 
            const containers = [document.getElementById('sprintContainer'), document.getElementById('keirinContainer')];
            scrollInterval = setInterval(() => {
                containers.forEach(el => {
                    if(el && el.scrollHeight > el.clientHeight) {
                        el.scrollTop += 1; 
                        // When hitting bottom, wait 2s then snap to top
                        if(el.scrollTop + el.clientHeight >= el.scrollHeight - 1) {
                             // Using a flag to prevent rapid resets
                             if(!el.isResetting) {
                                 el.isResetting = true;
                                 setTimeout(() => { 
                                     el.scrollTop = 0; 
                                     el.isResetting = false; 
                                 }, 2000);
                             }
                        }
                    }
                });
            }, 50); 
        }

        function stopScrolling() {
            if (scrollInterval) {
                clearInterval(scrollInterval);
                scrollInterval = null;
            }
        }

        if(eventID) {
            document.getElementById('eventTag').innerText = "LIVE: " + eventID.toUpperCase();
            document.getElementById('eventTag').className = "text-[0.65rem] inline-block bg-red-600 text-white px-2 py-0.5 rounded font-bold uppercase tracking-wider mt-1 animate-pulse";
            checkBranding(eventID); 
            startListener('sprint', 'sprintContainer', 'sprintRound');
            startListener('keirin', 'keirinContainer', 'keirinRound');
        } else {
            document.getElementById('eventTag').innerText = "NO SIGNAL";
            document.getElementById('eventTag').className = "text-[0.65rem] inline-block bg-slate-600 text-white px-2 py-0.5 rounded font-bold uppercase tracking-wider mt-1";
        }

        function startListener(type, containerId, badgeId) {
            onValue(ref(db, `events/${eventID}/${type}`), (snap) => {
                resetScrollTimer();
                const data = snap.val();
                const box = document.getElementById(containerId);
                const badge = document.getElementById(badgeId);
                box.innerHTML = '';

                if(!data || !data.heats) {
                    box.innerHTML = `<div class="text-center text-slate-500 py-10 italic">Waiting for Race Control...</div>`;
                    return;
                }

                badge.innerText = data.isFinished ? "FINAL STANDINGS" : "Round " + (data.roundCounter || 1);
                if(data.isFinished) badge.className = "text-xs bg-yellow-500 text-black px-3 py-1 rounded-full font-bold border border-yellow-300 shadow-lg shadow-yellow-500/20";

                // --- 1. CURRENT ROUND ---
                if(data.isFinished) {
                    box.innerHTML += `<div class="bg-slate-900/50 p-4 rounded-xl border border-yellow-500/30 mb-4 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-yellow-500"></div>
                        <div class="text-center font-black text-yellow-400 mb-3 tracking-widest text-lg">OFFICIAL RESULTS</div>
                        ${renderFinals(data.heats, data.riders)}
                    </div>`;
                } else {
                    box.innerHTML += `<div class="text-xs uppercase font-bold text-sky-400 mb-3 flex items-center"><span class="w-2 h-2 bg-sky-400 rounded-full mr-2 animate-ping"></span> On Track Now</div>`;
                    data.heats.forEach(h => { box.innerHTML += renderHeatCard(h, data.riders); });
                }

                // --- 2. HISTORY ---
                if(data.history && data.history.length > 0) {
                    [...data.history].reverse().forEach((hist, i) => {
                        let label = i === 0 ? "Most Recent" : "History";
                        let labelClass = i === 0 ? "bg-slate-600 text-white" : "bg-slate-800 text-slate-500";
                        box.innerHTML += `<div class="mt-8 pt-6 border-t-2 border-slate-700/50">
                            <div class="text-xs uppercase font-bold text-slate-500 mb-3 flex items-center justify-between">
                                <span>Round ${hist.round} Results</span>
                                <span class="text-[0.6rem] ${labelClass} px-2 py-0.5 rounded border border-slate-700">${label}</span>
                            </div>
                            <div class="opacity-80 hover:opacity-100 transition duration-500">
                                ${hist.heats.map(h => renderHeatCard(h, data.riders, true)).join('')}
                            </div>
                        </div>`;
                    });
                }
            });
        }

        function renderHeatCard(h, riders, isHistory=false) {
            let borderClass = isHistory ? 'border-slate-700' : 'border-slate-600 hover:border-slate-500';
            let bgClass = isHistory ? 'bg-slate-800' : 'bg-slate-800 shadow-lg';
            let catLabel = h.catName ? `<span class="bg-black/40 px-2 py-0.5 rounded text-[0.6rem] uppercase tracking-wider ml-2 text-slate-300 border border-white/10">${h.catName}</span>` : '';
            let timeDisplay = h.startTime ? `<span class="text-green-400 text-xs font-mono ml-auto flex items-center"><span class="mr-1">‚è∞</span>${h.startTime}</span>` : '';

            let html = `<div class="${bgClass} rounded-xl border ${borderClass} overflow-hidden mb-3 transition-all duration-300">
                <div class="bg-black/30 p-2 text-xs font-bold text-slate-400 flex justify-between items-center backdrop-blur-sm">
                    <div class="flex items-center"><span class="text-white">${h.name}</span> ${catLabel}</div>
                    <div class="flex items-center gap-2">${timeDisplay} <span>${h.riders ? h.riders.length : 0} Riders</span></div>
                </div>
                <div class="p-3 space-y-2">`;
            
            if(h.riders) {
                h.riders.forEach(r => {
                    let idx = (h.res||[]).indexOf(r.id);
                    let status = idx !== -1 ? `<span class="text-green-400 font-bold text-xs ml-2 bg-green-900/30 px-2 py-0.5 rounded border border-green-500/30">${idx+1}</span>` : '';
                    let dim = isHistory ? "text-slate-400" : "text-slate-200";
                    let bibDisplay = `#${r.bib||'-'}`;

                    if (r.status === 'DNS') {
                        dim = "text-slate-600 line-through decoration-slate-500";
                        status = '<span class="text-[0.6rem] bg-slate-700 text-slate-400 px-1 rounded">DNS</span>';
                    } else if (r.status === 'DSQ') {
                        dim = "text-red-400";
                        status = '<span class="text-[0.6rem] bg-red-900 text-red-300 px-1 rounded border border-red-700">DSQ</span>';
                    } else if (idx===0 && isHistory) {
                        dim = "text-green-400 font-bold";
                    }

                    html += `<div class="flex items-center justify-between text-sm group">
                        <div class="flex items-center">
                            <span class="w-8 text-slate-500 text-xs font-mono group-hover:text-slate-300 transition">${bibDisplay}</span>
                            <span class="font-medium ${dim}">${r.name}</span>
                            <span class="text-[0.6rem] text-slate-600 ml-2 font-mono">${r.time ? 'Q:'+r.time : ''}</span>
                        </div>
                        ${status}
                    </div>`;
                });
            }
            return html + `</div></div>`;
        }

        function renderFinals(heats, riders) {
            let list = [];
            heats.forEach((h, heatIdx) => {
               (h.res||[]).forEach((rid, placeIdx) => {
                   let r = (h.riders || []).find(x => x.id == rid);
                   if(r) list.push({ ...r, heatIdx, placeIdx, heatName: h.name });
               });
            });
            list.sort((a,b) => {
                if(a.heatIdx !== b.heatIdx) return a.heatIdx - b.heatIdx;
                return a.placeIdx - b.placeIdx;
            });

            let html = '';
            list.forEach((r, i) => {
                let podiumClass = "";
                let badge = "";

                if (i === 0) {
                    podiumClass = "podium-gold shadow-lg transform scale-[1.02] mb-2 rounded-lg font-black";
                    badge = "üèÜ 1ST";
                } else if (i === 1) {
                    podiumClass = "podium-silver mb-1 rounded-lg font-bold";
                    badge = "ü•à 2ND";
                } else if (i === 2) {
                    podiumClass = "podium-bronze mb-1 rounded-lg font-bold";
                    badge = "ü•â 3RD";
                } else {
                    podiumClass = "text-slate-400 border-b border-white/5 hover:bg-white/5";
                    badge = `<span class="text-slate-600 text-xs font-mono">${i+1}.</span>`;
                }

                html += `<div class="flex justify-between items-center text-sm ${podiumClass} py-3 px-4 transition-all">
                   <div class="flex items-center gap-3">
                       <span class="w-12">${badge}</span>
                       <span class="uppercase tracking-wide">${r.name}</span>
                   </div>
                   <div class="flex items-center gap-2">
                       <span class="text-[0.6rem] text-slate-500 font-mono">${r.time ? 'Q:'+r.time : ''}</span>
                       <span class="text-[0.65rem] opacity-60 font-mono uppercase tracking-wide">${r.heatName}</span>
                   </div>
               </div>`;
            });
            return html;
        }
    </script>
</body>
</html>
