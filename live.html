<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Results | SprintFutures</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Marquee Ticker */
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; }
        .marquee-content { display: inline-block; animation: marquee 30s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        
        /* Neon Glow */
        .neon-text { text-shadow: 0 0 10px rgba(56, 189, 248, 0.5), 0 0 20px rgba(56, 189, 248, 0.3); }

        /* Podium Effects */
        .podium-gold {
            background: linear-gradient(135deg, #846404 0%, #f6e27a 50%, #846404 100%);
            background-size: 200% 200%;
            animation: shimmer 3s linear infinite;
            color: #422a02; border: 1px solid #ffd700;
        }
        .podium-silver {
            background: linear-gradient(135deg, #3d4349 0%, #aeb5bc 50%, #3d4349 100%);
            background-size: 200% 200%;
            animation: shimmer 4s linear infinite;
            color: #1a202c; border: 1px solid #cbd5e0;
        }
        .podium-bronze {
            background: linear-gradient(135deg, #4b2c20 0%, #c48660 50%, #4b2c20 100%);
            background-size: 200% 200%;
            animation: shimmer 5s linear infinite;
            color: #2d1a12; border: 1px solid #d69e2e;
        }
        @keyframes shimmer { 0% {background-position: 0% 50%} 100% {background-position: 100% 50%} }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <div class="bg-slate-900 border-b border-slate-700 p-4 shadow-xl z-20">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center space-x-4 w-full md:w-auto justify-between md:justify-start">
                <div class="flex items-center space-x-3">
                    <a href="index.html" class="bg-slate-800 hover:bg-slate-700 p-3 rounded-xl text-slate-300 transition border border-slate-600">
                        <span class="text-xl">üè†</span>
                    </a>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-black tracking-tight text-white italic uppercase leading-none">Live Feed</h1>
                        <div id="eventTag" class="text-[0.65rem] inline-block bg-green-500 text-black px-2 py-0.5 rounded font-bold uppercase tracking-wider mt-1 shadow-[0_0_10px_rgba(34,197,94,0.6)]">Connecting...</div>
                    </div>
                </div>
            </div>
            
            <div class="w-full md:w-auto">
                <div class="bg-gradient-to-r from-slate-800 to-slate-900 border border-slate-600 rounded-xl p-4 flex flex-col items-center md:items-end shadow-2xl relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000 ease-in-out"></div>
                    <p class="text-[0.6rem] text-sky-400 uppercase tracking-[0.3em] font-bold mb-1">Official Event Partner</p>
                    <div class="font-black text-2xl md:text-4xl text-white tracking-tighter italic neon-text">
                        FREQUENCY <span class="text-sky-400">CYCLEWORKS</span>
                    </div>
                    <p class="text-xs text-slate-400 font-mono tracking-wide mt-1">High Performance Track Components</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="flex-grow p-4 overflow-hidden relative">
        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
            
            <!-- SPRINT COLUMN -->
            <div class="bg-slate-800/50 rounded-2xl overflow-hidden border border-slate-700 flex flex-col shadow-lg backdrop-blur-sm">
                <div class="bg-gradient-to-r from-red-600 to-red-800 p-4 flex justify-between items-center shadow-md z-10">
                    <div class="flex items-center space-x-2">
                        <span class="text-2xl">üö¥</span>
                        <h2 class="font-black text-xl italic uppercase tracking-wide">Sprint Ladder</h2>
                    </div>
                    <span id="sprintRound" class="text-xs bg-black/40 px-3 py-1 rounded-full font-mono border border-white/10">Round -</span>
                </div>
                <div id="sprintContainer" class="p-4 space-y-4 overflow-y-auto flex-grow scrollbar-hide relative">
                    <div class="text-center text-slate-500 py-20 animate-pulse font-mono">Waiting for race data...</div>
                </div>
            </div>

            <!-- KEIRIN COLUMN -->
            <div class="bg-slate-800/50 rounded-2xl overflow-hidden border border-slate-700 flex flex-col shadow-lg backdrop-blur-sm">
                <div class="bg-gradient-to-r from-indigo-600 to-indigo-800 p-4 flex justify-between items-center shadow-md z-10">
                    <div class="flex items-center space-x-2">
                        <span class="text-2xl">üèÅ</span>
                        <h2 class="font-black text-xl italic uppercase tracking-wide">Keirin Ladder</h2>
                    </div>
                    <span id="keirinRound" class="text-xs bg-black/40 px-3 py-1 rounded-full font-mono border border-white/10">Round -</span>
                </div>
                <div id="keirinContainer" class="p-4 space-y-4 overflow-y-auto flex-grow scrollbar-hide relative">
                    <div class="text-center text-slate-500 py-20 animate-pulse font-mono">Waiting for race data...</div>
                </div>
            </div>

        </div>
    </div>

    <!-- FOOTER -->
    <div class="bg-black border-t-4 border-orange-600 relative z-30">
        <div class="absolute left-0 top-0 bottom-0 bg-orange-600 text-white font-black text-xs px-2 flex items-center z-10 shadow-lg uppercase tracking-widest writing-vertical-lr sm:writing-horizontal-tb">Sponsors</div>
        <div class="marquee-container py-3 bg-gradient-to-b from-slate-900 to-black">
            <div class="marquee-content flex items-center space-x-16 px-4">
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-yellow-500 mr-2 text-2xl">‚ö°</span> WATTSHOP</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-red-600 mr-2 text-2xl">‚óè</span> MAVIC</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-white mr-2 text-2xl">üö≤</span> DOLAN</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-blue-500 mr-2 text-2xl">‚ñ≤</span> SHIMANO</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-orange-500 mr-2 text-2xl">‚ñ†</span> LOOK CYCLE</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-green-500 mr-2 text-2xl">‚ùñ</span> VELODROME SHOP</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-purple-500 mr-2 text-2xl">‚òÖ</span> KASK</span>
                 <!-- Duplicate -->
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-yellow-500 mr-2 text-2xl">‚ö°</span> WATTSHOP</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-red-600 mr-2 text-2xl">‚óè</span> MAVIC</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-white mr-2 text-2xl">üö≤</span> DOLAN</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-blue-500 mr-2 text-2xl">‚ñ≤</span> SHIMANO</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-orange-500 mr-2 text-2xl">‚ñ†</span> LOOK CYCLE</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-green-500 mr-2 text-2xl">‚ùñ</span> VELODROME SHOP</span>
                <span class="text-xl font-bold text-slate-300 flex items-center"><span class="text-purple-500 mr-2 text-2xl">‚òÖ</span> KASK</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAkTwI7TbJwXPbVQ2OrKjAAIaWLvyfuudc",
            authDomain: "sprintfutures.firebaseapp.com",
            databaseURL: "https://sprintfutures-default-rtdb.firebaseio.com",
            projectId: "sprintfutures",
            storageBucket: "sprintfutures.firebasestorage.app",
            messagingSenderId: "535060943616",
            appId: "1:535060943616:web:d15fc5225538eaeb3459e5",
            measurementId: "G-9XFQV3PLEV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const params = new URLSearchParams(window.location.search);
        const eventID = params.get('event');

        // --- AUTO SCROLL LOGIC ---
        let lastUpdate = Date.now();
        let scrollInterval = null;
        
        function resetScrollTimer() {
            lastUpdate = Date.now();
            stopScrolling(); // Stop if user just updated data
        }
        
        // Check for idleness every second
        setInterval(() => {
            if (Date.now() - lastUpdate > 60000) { // 60 Seconds
                startScrolling();
            }
        }, 1000);

        function startScrolling() {
            if (scrollInterval) return; // Already scrolling
            const containers = [document.getElementById('sprintContainer'), document.getElementById('keirinContainer')];
            
            scrollInterval = setInterval(() => {
                containers.forEach(el => {
                    if(el && el.scrollHeight > el.clientHeight) {
                        el.scrollTop += 1; // Pixel per tick
                        if(el.scrollTop + el.clientHeight >= el.scrollHeight) {
                            // Pause at bottom then reset
                            setTimeout(() => { el.scrollTop = 0; }, 2000);
                        }
                    }
                });
            }, 50); // Speed
        }

        function stopScrolling() {
            if (scrollInterval) {
                clearInterval(scrollInterval);
                scrollInterval = null;
                // Reset to top immediately on update
                document.getElementById('sprintContainer').scrollTop = 0;
                document.getElementById('keirinContainer').scrollTop = 0;
            }
        }

        if(eventID) {
            document.getElementById('eventTag').innerText = "LIVE: " + eventID.toUpperCase();
            document.getElementById('eventTag').className = "text-[0.65rem] inline-block bg-red-600 text-white px-2 py-0.5 rounded font-bold uppercase tracking-wider mt-1 animate-pulse";
            startListener('sprint', 'sprintContainer', 'sprintRound');
            startListener('keirin', 'keirinContainer', 'keirinRound');
        } else {
            document.getElementById('eventTag').innerText = "NO SIGNAL";
            document.getElementById('eventTag').className = "text-[0.65rem] inline-block bg-slate-600 text-white px-2 py-0.5 rounded font-bold uppercase tracking-wider mt-1";
        }

        function startListener(type, containerId, badgeId) {
            onValue(ref(db, `events/${eventID}/${type}`), (snap) => {
                resetScrollTimer(); // Data came in, reset idle timer
                
                const data = snap.val();
                const box = document.getElementById(containerId);
                const badge = document.getElementById(badgeId);
                box.innerHTML = '';

                if(!data || !data.heats) {
                    box.innerHTML = `<div class="text-center text-slate-500 py-10 italic">Waiting for Race Control...</div>`;
                    return;
                }

                badge.innerText = data.isFinished ? "FINAL STANDINGS" : "Round " + (data.roundCounter || 1);
                if(data.isFinished) badge.className = "text-xs bg-yellow-500 text-black px-3 py-1 rounded-full font-bold border border-yellow-300 shadow-lg shadow-yellow-500/20";

                // --- 1. CURRENT ROUND (Top of page) ---
                if(data.isFinished) {
                    box.innerHTML += `<div class="bg-slate-900/50 p-4 rounded-xl border border-yellow-500/30 mb-4 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-yellow-500"></div>
                        <div class="text-center font-black text-yellow-400 mb-3 tracking-widest text-lg">OFFICIAL RESULTS</div>
                        ${renderFinals(data.heats)}
                    </div>`;
                } else {
                    box.innerHTML += `<div class="text-xs uppercase font-bold text-sky-400 mb-3 flex items-center"><span class="w-2 h-2 bg-sky-400 rounded-full mr-2 animate-ping"></span> On Track Now</div>`;
                    data.heats.forEach(h => { box.innerHTML += renderHeatCard(h); });
                }

                // --- 2. HISTORY (Below Current Round) ---
                if(data.history && data.history.length > 0) {
                    // Reverse to show newest history first (Round 2, then Round 1)
                    [...data.history].reverse().forEach((hist, i) => {
                        let label = i === 0 ? "Most Recent" : "History";
                        let labelClass = i === 0 ? "bg-slate-600 text-white" : "bg-slate-800 text-slate-500";
                        
                        box.innerHTML += `<div class="mt-8 pt-6 border-t-2 border-slate-700/50">
                            <div class="text-xs uppercase font-bold text-slate-500 mb-3 flex items-center justify-between">
                                <span>Round ${hist.round} Results</span>
                                <span class="text-[0.6rem] ${labelClass} px-2 py-0.5 rounded border border-slate-700">${label}</span>
                            </div>
                            <div class="opacity-80 hover:opacity-100 transition duration-500">
                                ${hist.heats.map(h => renderHeatCard(h, true)).join('')}
                            </div>
                        </div>`;
                    });
                }
            });
        }

        function renderHeatCard(h, isHistory=false) {
            let borderClass = isHistory ? 'border-slate-700' : 'border-slate-600 hover:border-slate-500';
            let bgClass = isHistory ? 'bg-slate-800' : 'bg-slate-800 shadow-lg';
            
            let catLabel = h.catName ? `<span class="bg-black/40 px-2 py-0.5 rounded text-[0.6rem] uppercase tracking-wider ml-2 text-slate-300 border border-white/10">${h.catName}</span>` : '';

            let html = `<div class="${bgClass} rounded-xl border ${borderClass} overflow-hidden mb-3 transition-all duration-300">
                <div class="bg-black/30 p-2 text-xs font-bold text-slate-400 flex justify-between items-center backdrop-blur-sm">
                    <div class="flex items-center"><span class="text-white">${h.name}</span> ${catLabel}</div>
                    <span>${h.riders ? h.riders.length : 0} Riders</span>
                </div>
                <div class="p-3 space-y-2">`;
            
            if(h.riders) {
                h.riders.forEach(r => {
                    let idx = (h.res||[]).indexOf(r.id);
                    let status = idx !== -1 ? `<span class="text-green-400 font-bold text-xs ml-2 bg-green-900/30 px-2 py-0.5 rounded border border-green-500/30">${idx+1}</span>` : '';
                    let dim = isHistory ? "text-slate-400" : "text-slate-200";
                    if(idx===0 && isHistory) dim = "text-green-400 font-bold";

                    html += `<div class="flex items-center justify-between text-sm group">
                        <div class="flex items-center">
                            <span class="w-8 text-slate-500 text-xs font-mono group-hover:text-slate-300 transition">#${r.bib||'-'}</span>
                            <span class="font-medium ${dim}">${r.name}</span>
                        </div>
                        ${status}
                    </div>`;
                });
            }
            return html + `</div></div>`;
        }

        function renderFinals(heats) {
            let list = [];
            heats.forEach((h, heatIdx) => {
               (h.res||[]).forEach((rid, placeIdx) => {
                   // Fix: Look for rider inside the heat riders, not global undefined list
                   let r = (h.riders || []).find(x => x.id == rid);
                   if(r) list.push({ ...r, heatIdx, placeIdx, heatName: h.name });
               });
            });
            list.sort((a,b) => {
                if(a.heatIdx !== b.heatIdx) return a.heatIdx - b.heatIdx;
                return a.placeIdx - b.placeIdx;
            });

            let html = '';
            list.forEach((r, i) => {
                let podiumClass = "";
                let badge = "";

                if (i === 0) {
                    podiumClass = "podium-gold shadow-lg transform scale-[1.02] mb-2 rounded-lg font-black";
                    badge = "üèÜ 1ST";
                } else if (i === 1) {
                    podiumClass = "podium-silver mb-1 rounded-lg font-bold";
                    badge = "ü•à 2ND";
                } else if (i === 2) {
                    podiumClass = "podium-bronze mb-1 rounded-lg font-bold";
                    badge = "ü•â 3RD";
                } else {
                    podiumClass = "text-slate-400 border-b border-white/5 hover:bg-white/5";
                    badge = `<span class="text-slate-600 text-xs font-mono">${i+1}.</span>`;
                }

                html += `<div class="flex justify-between items-center text-sm ${podiumClass} py-3 px-4 transition-all">
                   <div class="flex items-center gap-3">
                       <span class="w-12">${badge}</span>
                       <span class="uppercase tracking-wide">${r.name}</span>
                   </div>
                   <span class="text-[0.65rem] opacity-60 font-mono uppercase tracking-wide">${r.heatName}</span>
               </div>`;
            });
            return html;
        }
    </script>
</body>
</html>
